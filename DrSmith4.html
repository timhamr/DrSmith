<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat-Support - Dr. Smith Medical Clinic</title>
    
    <link rel="shortcut icon" href="https://tierzahnzentrum.com/wp-content/uploads/2024-TierZahnZentrum-icon-rgb.svg#150" type="image/svg+xml">
    <link rel="apple-touch-icon" href="https://tierzahnzentrum.com/wp-content/uploads/2024-TierZahnZentrum-icon-rgb.svg#150">
    <meta name="theme-color" content="#ffffff">

    <style>
        /* Font Import: Plus Jakarta Sans */
        @font-face {
            font-family: 'Plus Jakarta Sans';
            src: url('https://tierzahnzentrum.com/wp-content/uploads/2024/08/PlusJakartaSans-Regular.ttf#139') format('truetype');
            font-weight: 400; font-style: normal; font-display: swap;
        }
        @font-face {
            font-family: 'Plus Jakarta Sans';
            src: url('https://tierzahnzentrum.com/wp-content/uploads/2024/08/PlusJakartaSans-Bold.ttf#142') format('truetype');
            font-weight: 700; font-style: normal; font-display: swap;
        }
        @font-face {
            font-family: 'Plus Jakarta Sans';
            src: url('https://tierzahnzentrum.com/wp-content/uploads/PlusJakartaSans-SemiBold.ttf#805') format('truetype');
            font-weight: 600; font-style: normal; font-display: swap;
        }
        @font-face {
            font-family: 'Plus Jakarta Sans';
            src: url('https://tierzahnzentrum.com/wp-content/uploads/2024/08/PlusJakartaSans-Medium.ttf#141') format('truetype');
            font-weight: 500; font-style: normal; font-display: swap;
        }

        /* CSS Variables for theming */
        :root {
            --primary-color: #0084AC;
            --primary-color-darker: #006A8A; 
            --secondary-color: #E9F6FA; 
            --user-message-bg: #0084AC; 
            --ai-message-bg: #E9F6FA;   
            --text-color: #333333;
            --text-color-light: #ffffff;
            --text-color-secondary: #555555;
            --border-color: #DDE4E8;
            --background-color: #ffffff;
            --content-bg-color: #F2F6FA;
            --font-family: 'Plus Jakarta Sans', Arial, sans-serif;
            --footer-height: auto; 
        }

        /* Basic body and link styling */
        body {
            font-family: var(--font-family);
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        a { color: var(--primary-color); text-decoration: none; }
        a:hover { text-decoration: underline; }

        /* Site Header styling */
        /* --- НАЧАЛО НОВЫХ/ОБНОВЛЕННЫХ СТИЛЕЙ ДЛЯ HEADER --- */
    .site-header {
        background-color: var(--background-color);
        border-bottom: 1px solid var(--border-color);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        position: sticky;
        top: 0;
        z-index: 1000;
        height: 80px; /* Высота для десктопной версии хедера */
    }

    .header-content-wrapper {
        max-width: 1200px; /* Ограничиваем максимальную ширину контента хедера */
        margin: 0 auto; /* Центрируем контент хедера */
        padding: 0 30px; /* Боковые отступы для десктопа */
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .logo-container img { 
        height: 45px; 
        width: auto; 
        display: block; /* Убирает лишний отступ под img */
    }

    /* Навигация на десктопе */
    .main-nav {
        display: flex; /* Показываем на десктопе */
        flex-grow: 1; /* Позволяем навигации занимать доступное пространство */
        justify-content: center; /* Центрируем пункты меню */
    }
    .main-nav .nav {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        align-items: center;
    }
    .main-nav .nav-item {
        margin-left: 15px; /* Уменьшен отступ между пунктами */
        margin-right: 15px;
        position: relative;
    }
    .main-nav .nav-link {
        color: var(--text-color);
        font-weight: 500;
        font-size: 15px; /* Можно настроить размер */
        text-decoration: none;
        padding: 5px 0;
    }
    /* Стиль активной ссылки и при наведении (убрал нижнее подчеркивание, как на скриншоте 2) */
    .main-nav .nav-link:hover,
    .main-nav .nav-item.active .nav-link {
        color: var(--primary-color);
        /* border-bottom: 2px solid var(--primary-color); /* Убрано подчеркивание */
    }
    /* Стили для подменю остаются прежними, если они нужны */
    .main-nav .submenu { display: none; position: absolute; top: 100%; left: 0; background-color: var(--background-color); border: 1px solid var(--border-color); box-shadow: 0 3px 5px rgba(0,0,0,0.1); list-style: none; padding: 0; margin: 0; min-width: 200px; z-index: 1001; }
    .main-nav .submenu .nav-item { margin-left: 0; width: 100%; }
    .main-nav .submenu .nav-link { display: block; padding: 10px 15px; font-size: 14px; border-bottom: none; }
    .main-nav .submenu .nav-link:hover { background-color: var(--secondary-color); }
    .main-nav .nav-item.has-dropdown:hover .submenu { display: block; }

    .header-actions {
        display: flex;
        align-items: center;
        gap: 15px; /* Отступ между элементами в блоке контактов */
    }
    .header-actions .header-icon {
        height: 24px; /* Размер иконок */
        width: 24px;
        display: block;
    }
    .header-actions .contact-phone-link {
        display: flex;
        align-items: center;
        gap: 8px; /* Отступ между иконкой телефона и номером */
        color: var(--text-color);
        font-weight: 500;
    }
    .header-actions .phone-number-text {
        font-size: 14px; /* Размер текста номера телефона */
    }
    .header-actions .call-btn.header-call-btn { /* Стили для кнопки "Jetzt anrufen" */
        background-color: var(--primary-color);
        color: var(--text-color-light);
        padding: 8px 15px; /* Размеры кнопки */
        border-radius: 5px;
        text-decoration: none;
        font-weight: 500;
        font-size: 14px;
        white-space: nowrap; /* Чтобы текст не переносился */
    }
    .header-actions .call-btn.header-call-btn:hover {
        background-color: var(--primary-color-darker);
    }
    .contact-email-link .header-icon { /* Для выравнивания, если нужно */
         display: block;
    }

    .mobile-menu-toggle {
        display: none; /* Скрыт на десктопе */
        background: none;
        border: none;
        font-size: 28px; 
        color: var(--text-color);
        cursor: pointer;
        padding: 5px; /* Увеличим кликабельную область */
    }

    /* Адаптация для мобильных устройств */
    @media (max-width: 992px) { /* Планшеты и мобильные */
        .site-header {
            height: 60px; /* Фиксированная высота для мобильного хедера */
        }
        .header-content-wrapper {
            padding: 0 15px; /* Меньше отступы на мобильных */
        }
        .main-nav {
            /* Стили для мобильного меню-оверлея */
            display: none; /* Изначально скрыто, управляется JS */
            flex-direction: column;
            position: fixed;
            top: 0; /* Начинается от верха */
            left: -100%; /* Изначально скрыто за левым краем */
            width: 80%; /* Ширина меню, например 80% */
            max-width: 300px; /* Максимальная ширина */
            height: 100vh;
            background-color: var(--background-color);
            z-index: 1090; 
            padding: 20px;
            padding-top: 70px; /* Отступ сверху, чтобы не перекрывать хедер или кнопку закрытия */
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            overflow-y: auto;
            transition: left 0.3s ease-in-out; /* Анимация появления */
        }
        .main-nav.mobile-active { /* Класс для активного мобильного меню */
            display: flex !important;
            left: 0; /* Показываем меню */
        }
        .main-nav .nav {
            flex-direction: column;
            width: 100%;
            align-items: flex-start; /* Выравнивание пунктов по левому краю */
        }
        .main-nav .nav-item {
            margin: 0; /* Убираем отступы слева/справа */
            width: 100%;
        }
        .main-nav .nav-link {
            font-size: 18px; 
            padding: 15px 10px; /* Больше отступы для удобства нажатия */
            display: block; 
            border-bottom: 1px solid var(--border-color);
            width: 100%;
            text-align: left;
        }
        .main-nav .nav-item:last-child .nav-link {
            border-bottom: none;
        }
        .main-nav .submenu { /* Подменю на мобильных */
            position: static;
            box-shadow: none;
            border: none;
            border-top: 1px dashed var(--border-color);
            width: auto;
            margin-left: 20px; /* Небольшой отступ для вложенности */
            padding-left: 0;
            background-color: transparent;
        }
        .main-nav .submenu .nav-link {
            font-size: 16px;
            padding: 10px;
            border-bottom: none; /* Убираем двойные линии */
        }
        /* JS потребуется для раскрытия подменю по клику на мобильных */

        /* .main-nav .nav-item.has-dropdown > .nav-link::after {
            content: '▼';
            font-size: 0.7em;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
        } */
        /* .main-nav .nav-item.has-dropdown.open > .nav-link::after {
            content: '▲';
        } */


        .header-actions .phone-number-text {
            display: none; /* Скрываем текст номера телефона */
        }
        .header-actions .call-btn.header-call-btn {
            display: none; /* Скрываем кнопку "Jetzt anrufen" */
        }
        .header-actions .header-icon { /* Иконки могут быть чуть меньше на мобильных */
            height: 22px;
            width: 22px;
        }
         .header-actions {
            gap: 12px; /* Поменьше отступ между иконками */
        }

        .mobile-menu-toggle {
            display: block !important; /* Показываем кнопку бургер-меню */
            z-index: 1100; /* Чтобы была поверх меню, когда оно выдвигается */
        }

    }

    /* --- КОНЕЦ НОВЫХ/ОБНОВЛЕННЫХ СТИЛЕЙ ДЛЯ HEADER --- */
        /* Hidden Controls Container */
        #hiddenControlsContainer {
            display: none; /* Hidden from user */
            padding: 10px 20px;
            text-align: center;
            background-color: #e0e0e0; /* Different bg to distinguish if ever shown */
            border-bottom: 1px solid var(--border-color);
        }
        #hiddenControlsContainer label {
            margin-right: 8px;
            font-weight: 500;
        }
        #hiddenControlsContainer select, #hiddenControlsContainer input {
            padding: 5px 8px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            font-family: var(--font-family);
            font-size: 14px;
            margin-right: 15px;
        }



        /* Chat page layout */
        .chat-page-wrapper {
            flex-grow: 1;
            background-color: var(--content-bg-color);
            display: flex;
            justify-content: center; */ /* <--- ЭТУ СТРОКУ УДАЛИТЬ или ЗАКОММЕНТИРОВАТЬ */
            align-items: flex-start; /* <--- ЗАМЕНИТЬ НА align-items: flex-start; */
            padding: 20px;
            box-sizing: border-box;
            gap: 20px; /* Space between chat container and citations panel */
        }
        .chat-container {
            /* width: 100%; */ /* <--- ЭТУ СТРОКУ УДАЛИТЬ или ЗАКОММЕНТИРОВАТЬ */
            max-width: 800px;
            flex-grow: 1; /* Allow chat container to take up more space */
            height: 70vh; 
            max-height: 600px; 
            min-height: 450px;
            background-color: var(--background-color);
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Chat messages area */
        .chat-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px; 
        }

        .message-wrapper {
            display: flex;
            max-width: 85%; 
        }
        
        .ai-message-wrapper {
            align-self: flex-start;
            flex-direction: row; 
            gap: 10px;
        }
/* --- Smooth message entrance --- */
@keyframes msgFadeSlide {
    0%   { opacity: 0; transform: translateY(10px); }
    100% { opacity: 1; transform: translateY(0); }
}

.message-wrapper.animate-in {
    animation: msgFadeSlide 0.35s ease-out forwards;
}
        .user-message-wrapper {
            align-self: flex-end;
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary-color); 
            color: var(--primary-color); 
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px; 
            object-fit: cover; 
            flex-shrink: 0;
        }
        .avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .message-content-wrapper {
            display: flex;
            flex-direction: column;
            max-width: calc(100% - 50px); 
        }
        
        .sender-name {
            font-size: 0.85em;
            font-weight: 600;
            color: var(--text-color); /* Made name slightly more prominent */
            margin-bottom: 2px;
        }
        .sender-title {
            font-size: 0.75em;
            color: var(--text-color-secondary);
            margin-bottom: 4px;
        }
        .ai-message-wrapper .sender-name, .ai-message-wrapper .sender-title {
            margin-left: 2px; 
        }
        .user-message-wrapper .sender-name, .user-message-wrapper .sender-title {
            text-align: right;
            margin-right: 2px;
        }


        .message { 
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.6;
            font-size: 15px;
            word-wrap: break-word;
            position: relative; 
        }
        .message p { margin: 0 0 3px 0; white-space: normal; }
        .user-message p { white-space: nowrap !important; }
        .message .timestamp { font-size: 0.7em; color: #888; display: block; margin-top: 4px; }

        .ai-message { 
            background-color: var(--ai-message-bg); 
            color: var(--text-color); 
            border-bottom-left-radius: 5px; 
            align-self: flex-start; 
        }
        .ai-message .timestamp { text-align: left; }
        
        .ai-message-wrapper.typing-indicator .message p { font-style: italic; color: var(--text-color-secondary); }
        .ai-message-wrapper.typing-indicator .message { background-color: transparent; box-shadow: none; padding-left:0; }


        .user-message { 
            background-color: var(--user-message-bg); 
            color: var(--text-color-light); 
            border-bottom-right-radius: 5px; 
            align-self: flex-end; 
        }
        .user-message .timestamp { text-align: right; color: rgba(255,255,255,0.7); }


        /* Chat input area */
        .chat-input-area { display: flex; padding: 15px 20px; border-top: 1px solid var(--border-color); background-color: #f9f9f9; }
        .chat-input-area textarea {
            flex-grow: 1; padding: 12px 18px; border: 1px solid var(--border-color); border-radius: 22px;
            resize: none; min-height: 24px; max-height: 120px; overflow-y: auto;
            font-family: var(--font-family); font-size: 15px; line-height: 1.5; margin-right: 10px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.06);
        }
        .chat-input-area textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(0, 132, 172, 0.2); }
        
        .chat-input-area button {
            background-color: var(--primary-color); color: var(--text-color-light); border: none;
            padding: 0 25px; border-radius: 22px; cursor: pointer; font-size: 15px; font-weight: 600;
            transition: background-color 0.2s ease, box-shadow 0.3s ease; 
            display: flex; align-items: center; justify-content: center;
        }
        .chat-input-area button:hover { background-color: var(--primary-color-darker); }
        .chat-input-area button:disabled { background-color: #b0bec5; cursor: not-allowed; }
        .chat-input-area button svg { width: 18px; height: 18px; fill: currentColor; }

        /* Subtle Glow Animation for Send Button */
        @keyframes subtleGlow {
            0% { box-shadow: 0 0 4px rgba(0, 132, 172, 0.2); }
            50% { box-shadow: 0 0 12px rgba(0, 132, 172, 0.6); }
            100% { box-shadow: 0 0 4px rgba(0, 132, 172, 0.2); }
        }
        .highlight-send-button {
            animation: subtleGlow 1.5s ease-in-out 2; /* Glows for 3 seconds total */
        }


        /* Source citation button and tooltip */
        .source-button {
            display: inline-block; background-color: var(--primary-color); color: white;
            border: none; border-radius: 50%; width: 20px; height: 20px;
            font-size: 12px; font-weight: bold; line-height: 20px; text-align: center;
            cursor: pointer; margin-left: 5px; position: relative; vertical-align: super;
        }
        .source-button .tooltip-text {
            visibility: hidden; width: max-content; max-width: 250px;
            background-color: #555; color: #fff; text-align: left; 
            border-radius: 6px; padding: 8px 12px; position: absolute; z-index: 1;
            bottom: 135%; 
            left: 50%; transform: translateX(-50%); opacity: 0;
            transition: opacity 0.3s, visibility 0.3s; font-size: 12px;
            font-weight: normal; line-height: 1.4; white-space: normal;
        }
        .source-button:hover .tooltip-text { visibility: visible; opacity: 1; }
        .source-button .tooltip-text::after { 
            content: ""; position: absolute; top: 100%; left: 50%;
            margin-left: -5px; border-width: 5px; border-style: solid;
            border-color: #555 transparent transparent transparent;
        }

        /* Citations Panel Styles */
        .citations-panel {
            width: 320px; /* Fixed width for the panel */
            flex-shrink: 0; /* Prevent panel from shrinking */
            height: 70vh; /* Match chat container height */
            max-height: 600px; /* Match chat container max-height */
            background-color: var(--background-color);
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            font-size: 0.83em;
        }
        .citations-panel.hidden {
            display: none;
        }
        .citations-panel h3 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: 600;
        }
        .citations-panel ul {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1; 
        }
        .citations-panel li {
            margin-bottom: 18px;
            padding-bottom: 18px;
            border-bottom: 1px solid #efefef; 
            display: flex; /* For aligning icon and text */
            align-items: flex-start; /* Align items to the top */
            gap: 10px; /* Space between icon and text block */
        }
        .citations-panel li:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .citations-panel .source-favicon {
            width: 16px; /* Favicon size */
            height: 16px;
            flex-shrink: 0; /* Prevent icon from shrinking */
            margin-top: 3px; /* Align with first line of title */
        }
        .citations-panel .source-details {
            flex-grow: 1; /* Allow text block to take remaining space */
        }
        .citations-panel .source-title {
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 4px;
            font-size: 0.9em;
        }
        .citations-panel .source-url {
            font-size: 0.8em;
            color: var(--primary-color);
            margin-bottom: 6px;
            display: block;
            word-break: break-all;
        }
        .citations-panel .source-url a {
            color: var(--primary-color);
        }
        .citations-panel .source-url a:hover {
            text-decoration: underline;
        }
        .citations-panel .source-description {
            font-size: 0.85em;
            color: var(--text-color-secondary);
            line-height: 1.4;
            margin-bottom: 6px;
        }
        .citations-panel .source-meta {
            font-size: 0.75em;
            color: #777;
            margin-top: 8px;
        }
        .citations-panel .source-meta span {
            display: block;
            margin-bottom: 3px;
        }
        .citations-panel .source-meta span:last-child {
            margin-bottom: 0;
        }
        .citations-panel .empty-state {
            text-align: center;
            color: var(--text-color-secondary);
            font-style: italic;
            margin-top: 20px; 
            flex-grow: 1; 
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
        }
        /* Responsive adjustments for citations panel */
        @media (max-width: 768px) { 
            .chat-page-wrapper {
                flex-direction: column; /* Stack chat and citations on mobile */
            }
            .citations-panel {
                width: 100%; /* Full width on mobile */
                max-height: 250px; /* Limit height on mobile */
                height: auto; /* Adjust height based on content up to max-height */
                margin-top: 0; /* Remove top margin if chat-page-wrapper gap handles it */
            }
            /* Adjust chat container height if panel is below it */
            .chat-container { 
                /* Original calculation: height: calc(100vh - 60px - 20px - 250px - 20px); /* header - wrapper padding - panel max_height - gap */
                /* Corrected calculation: Ensure it doesn't go negative and considers existing calculations */
                /* Let's re-evaluate the mobile chat container height considering the new panel */
                /* Assuming header is 60px, wrapper padding is 20px top/bottom (total 40px), panel is 250px, gap is 20px */
                /* Total vertical space used by other elements: 60 (header) + 20 (wrapper top) + 250 (panel) + 20 (gap) + 20 (wrapper bottom) = 370px */
                /* So, chat container height could be: calc(100vh - 370px) - but this might be too aggressive. */
                /* Let's stick to the provided calculation and ensure it's applied correctly. */
                 height: calc(100vh - 60px - 20px - 250px - 20px); /* header (60) - wrapper padding (20) - panel max_height (250) - gap (20) */
                 /* This calculation was for when the panel is *below* the chat.
                    If the panel is *above* or if the flex-direction is column, the interaction is different.
                    The current CSS stacks them, so the chat container height needs to be reduced.
                 */
            } 
        }


        /* Site Footer styling (condensed for brevity) */
        /* --- НАЧАЛО НОВЫХ СТИЛЕЙ ДЛЯ FOOTER --- */
.site-footer {
    padding: 40px 40px 20px 40px; /* Увеличен верхний отступ, уменьшен нижний */
    background-color: var(--content-bg-color); /* Используем content-bg-color как на скриншоте */
    border-top: 1px solid var(--border-color);
    color: var(--text-color-secondary);
    font-size: 14px;
    line-height: 1.7;
}

.footer-content {
    max-width: 1100px; /* Слегка уменьшил для соответствия скриншоту */
    margin: 0 auto;
    display: grid;
    grid-template-columns: 0.9fr 1.2fr 0.9fr; /* Пропорции колонок, средняя шире */
    gap: 30px; /* Отступ между колонками */
    align-items: start;
}

.footer-column h5, .footer-column h4 {
    font-size: 16px;
    color: var(--text-color);
    font-weight: 600; /* или 500, как на скриншоте */
    margin-top: 0;
    margin-bottom: 15px;
}
.footer-column-1 .footer-clinic-name { /* Для имени клиники может быть чуть больше отступ снизу */
    margin-bottom: 10px;
}
.footer-column-1 .footer-address {
    margin-bottom: 20px;
    font-size: 13px; /* Чуть меньше для адреса */
    line-height: 1.6;
}
.footer-column-1 .footer-address a {
    color: var(--text-color-secondary); /* Ссылки в адресе */
}
.footer-column-1 .footer-address a:hover {
    color: var(--primary-color);
}


.footer-social-icons {
    display: flex;
    gap: 12px; /* Отступ между иконками соцсетей */
}
.footer-social-icons img {
    width: 28px; /* Размер иконок */
    height: 28px;
    opacity: 0.8; /* Слегка приглушенные */
    transition: opacity 0.2s ease;
}
.footer-social-icons a:hover img {
    opacity: 1;
}

/* Центральная колонка */
.footer-column-2 {
    text-align: center;
}
.footer-center-logo {
    height: 45px; /* Размер логотипа-лапки */
    width: auto;
    margin: 0 auto 15px auto;
    display: block;
}
.footer-column-2 .footer-question {
    font-size: 15px; /* Размер текста "Sie haben Fragen?" */
    font-weight: 500;
    color: var(--text-color);
    margin-bottom: 8px;
}
.footer-contact-email {
    margin-bottom: 20px;
}
.footer-contact-email a {
    font-size: 1.4em; /* Размер email адреса */
    font-weight: 600; /* Полужирный */
    color: var(--primary-color);
    word-break: break-all;
}
.footer-contact-email a:hover {
    text-decoration: underline;
}

.footer-buttons {
    display: flex;
    justify-content: center;
    gap: 10px; /* Отступ между кнопками */
    flex-wrap: wrap; /* Перенос кнопок, если не помещаются */
}
.btn.footer-btn { /* Общие стили для кнопок в футере */
    padding: 10px 25px;
    font-size: 14px;
    font-weight: 500;
    border-radius: 5px;
    text-decoration: none;
    transition: all 0.3s ease;
    min-width: 140px; /* Минимальная ширина кнопок */
    box-sizing: border-box;
}
.btn-primary.footer-btn {
    background-color: var(--primary-color);
    color: var(--text-color-light);
    border: 1px solid var(--primary-color);
}
.btn-primary.footer-btn:hover {
    background-color: var(--primary-color-darker);
    border-color: var(--primary-color-darker);
}
.btn-outline.footer-btn {
    background-color: transparent;
    color: var(--primary-color);
    border: 1px solid var(--primary-color);
}
.btn-outline.footer-btn:hover {
    background-color: var(--primary-color);
    color: var(--text-color-light);
}


.footer-links-list {
    list-style: none;
    padding: 0;
    margin: 0;
}
.footer-links-list li {
    margin-bottom: 8px;
}
.footer-links-list a {
    color: var(--text-color-secondary);
    font-size: 14px;
}
.footer-links-list a:hover {
    color: var(--primary-color);
}

.footer-copyright {
    text-align: center;
    padding-top: 30px; /* Увеличен верхний отступ сверху */
    margin-top: 30px; /* Увеличен верхний отступ сверху */
    border-top: 1px solid var(--border-color);
    font-size: 13px;
    color: var(--text-color-secondary);
}

/* Адаптация футера для мобильных устройств */
@media (max-width: 768px) {
    .site-footer {
        padding: 30px 20px 20px 20px; /* Уменьшены боковые отступы */
    }
    .footer-content {
        grid-template-columns: 1fr; /* Одна колонка */
        gap: 30px; /* Отступ между блоками при вертикальном расположении */
        text-align: center; /* Центрирование текста в колонках */
    }

    .footer-column-1 .footer-address,
    .footer-column-1 .footer-clinic-name {
        text-align: center; /* Явно центрируем адрес */
    }

    .footer-social-icons {
        justify-content: center; /* Центрируем иконки соцсетей */
        margin-top: 15px;
        margin-bottom: 15px; /* Добавим отступ снизу */
    }

    .footer-center-logo {
        margin-top: 0; /* Убрать верхний отступ у лого, если он был */
        margin-bottom: 10px;
        height: 40px;
    }
    .footer-contact-email a {
        font-size: 1.2em; /* Чуть меньше email на мобильных */
    }
    .footer-buttons {
        flex-direction: column; /* Кнопки одна под другой */
        align-items: center; /* Центрируем кнопки */
        gap: 12px;
    }
    .btn.footer-btn {
        width: 100%; /* Кнопки на всю ширину (ограничены max-width) */
        max-width: 280px; /* Максимальная ширина кнопок */
    }
    /* Скрываем правую колонку со ссылками на мобильных, как на скриншоте */
    .footer-column-3 {
        display: none; 
    }
     /* Чтобы центральная колонка (Paw, Sie haben Fragen, email, buttons) шла ПЕРЕД информацией о клинике на мобильных */
    .footer-column-2 { order: -1; } /* Поднимаем этот блок наверх */

}
/* --- КОНЕЦ НОВЫХ СТИЛЕЙ ДЛЯ FOOTER --- */
/* === Profile card shown before chat starts ====================== */
.persona-profile-card{
    text-align:center;
    padding:32px 24px;
    border:2px solid var(--border-color);
    border-radius:12px;
    margin-bottom:20px;                 /* keeps distance to first message */
}
.persona-profile-card .profile-heading{
    font-weight:600;
    color:var(--primary-color);
    margin:0 0 12px;
    font-size:1.1rem;
}
.persona-profile-card .profile-photo{
    width:96px;height:96px;
    margin:0 auto 12px;
    border-radius:50%;
    overflow:hidden;
}
.persona-profile-card .profile-photo img{width:100%;height:100%;object-fit:cover}
.persona-profile-card .profile-emoji{font-size:72px;line-height:1}
.persona-profile-card .profile-name{margin:0;font-size:1.25rem}
.persona-profile-card .profile-title{
    margin:4px 0 0;
    font-size:.9rem;
    color:var(--text-color-secondary);
}
/* =============================================================== */

        /* End Scenario Modal (condensed for brevity) */
        .end-scenario-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .end-scenario-modal { background-color: white; padding: 30px 40px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); text-align: center; }
        .end-scenario-modal p { font-size: 18px; color: var(--text-color); margin-bottom: 20px; }
        .end-scenario-modal button { background-color: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 500; }
        .end-scenario-modal button:hover { background-color: var(--primary-color-darker); }

        /* Responsive adjustments (condensed for brevity) */
        /* The general responsive rules were here. Some might be overridden by the new citations panel rules or need adjustment. */
        @media (max-width: 992px) { 
            /* .main-nav { display: none; }  Already handled by header styles */
            /* .mobile-menu-toggle { display: block; } Already handled */
            /* .site-header .header-contact { display: none; } Already handled */
            /* .header-main { justify-content: space-between; } Already handled */
            .message-wrapper { max-width: 90%; } 
        }
        
        /* Combined mobile styles for 768px and below */
        @media (max-width: 768px) {
            /* .site-header { padding: 10px 15px; } Already handled */
            /* .header-top { justify-content: center; font-size: 13px; } No .header-top class in current HTML */
            /* .header-top .contact-phone { margin-right: 10px;} */
            /* .header-top .call-btn { margin-right: 10px; padding: 5px 10px; font-size: 12px;} */
            /* .header-top .contact-phone img, .header-top .contact-email img { height: 18px; width: 18px; } */
            /* .header-main .logo-container img { height: 40px; } Already handled */
            
            /* .chat-page-wrapper styling is now handled by the new citations panel rules */
            
            /* .chat-container height is now handled by the new citations panel rules for mobile */
            /* .chat-container { max-height: none; min-height: 300px; border-radius: 8px; } */ /* Some parts might still be relevant */
             .chat-container {
                min-height: 300px; /* Retain min-height */
                border-radius: 8px; /* Retain border-radius for mobile */
             }


            .message-wrapper { max-width: 95%; }
            .message { font-size: 14px; }
            .avatar { width: 35px; height: 35px; font-size: 24px; }
            .message-content-wrapper { max-width: calc(100% - 45px); }
            .sender-name { font-size: 0.8em; }
            .sender-title {font-size: 0.7em;}
            .chat-input-area textarea { padding: 10px 15px; font-size: 14px; }
            .chat-input-area button { padding: 0 20px; font-size: 14px; }
            
            /* .footer-content, .footer-column, .footer-social-icons, .site-footer already handled by footer styles */
            
            .end-scenario-modal { width: 80%; padding: 20px;}
            .end-scenario-modal p { font-size: 16px;}
        }
    </style>
</head>
<body>

    <header class="site-header">
        <div class="header-content-wrapper">
            <div class="logo-container">
  <class="logo-text">Dr. Smith<span class="logo-highlight"> Medical Clinic</span></a>
</div>

            <nav class="main-nav" id="mainNav">
                <ul class="nav">
                    <li class="nav-item"><class="nav-link">Our Team</a>
                    <li class="nav-item"><class="nav-link">Services</a>
					<li class="nav-item"><class="nav-link">Contact</a></li>
                    <li class="nav-item"><class="nav-link">Emergency</a></li>
                </ul>
            </nav>
            <div class="header-actions">
                <a href="tel:+1 123 456 7890" class="contact-phone-link">
                    <img src="https://tierzahnzentrum.com/wp-content/uploads/telefon-kontakt-icon.svg" alt="Phone Icon" class="header-icon" onerror="this.onerror=null;this.src='https://placehold.co/24x24/eeeeee/999999?text=P';">
                    <span class="phone-number-text">+1 123 456 7890</span>
                </a>
                <a href="tel:+1 123 456 7890" class="btn call-btn header-call-btn">Call now</a>
                <a href="mailto:info@drsmithclinic.com" class="contact-email-link" title="Email us">
                    <img src="https://tierzahnzentrum.com/wp-content/uploads/e-mail-kontakt-icon.svg" alt="Email Icon" class="header-icon" onerror="this.onerror=null;this.src='https://placehold.co/24x24/eeeeee/999999?text=E';">
                </a>
            </div>
            <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Open Menu">☰</button>
        </div>
    </header>

    <div id="hiddenControlsContainer">
        <label for="personaToggleInternal">Antworten als (intern):</label>
        <select id="personaToggleInternal">
            <option value="bot" selected>VetBot</option>  <option value="human">Lena Bauer</option>
        </select>
        <label for="sourcesToggleInternal">Quellen anzeigen (intern):</label>
        <input type="checkbox" id="sourcesToggleInternal">
    </div>

    <div class="chat-page-wrapper">
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <!-- Profile card will be injected here -->
                <div id="profileCardMount"></div>
            </div>
            <div class="chat-input-area">
                <textarea id="userInput" placeholder="Your answer will appear here" rows="1" disabled></textarea>
                <button id="sendButton" title="Send" disabled>
                    <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                </button>
            </div>
        </div>
        <!-- Шаг 1: Добавление HTML-структуры для панели цитат -->
        <!-- <div id="citationsPanel" class="citations-panel hidden"> -->
            <!-- <h3>Citations</h3> -->
            <!-- <ul id="citationsList"> -->
                <!-- <!-- Citations will be populated here by JavaScript -->
            <!-- </ul> -->
        <!-- </div> -->
    </div>

    <footer class="site-footer">
  <div class="footer-content">

    <!-- Left column: Practice info -->
    <div class="footer-column footer-column-1">
      <h5 class="footer-clinic-name">Dr. Smith Medical Clinic</h5>
      <p class="footer-address">
        123 Main Street<br>
        Springfield, IL 62701<br>
        Tel: <a href="tel:+11234567890">+1 123 456 7890</a><br>
        Email: <a href="mailto:info@drsmithclinic.com">info@drsmithclinic.com</a>
      </p>
      <div class="footer-social-icons">
        <a href="https://www.facebook.com/drsmithclinic" target="_blank" title="Facebook">
          <img src="https://placehold.co/28x28/777777/FFFFFF?text=F" alt="Facebook">
        </a>
        <a href="https://www.instagram.com/drsmithclinic" target="_blank" title="Instagram">
          <img src="https://placehold.co/28x28/777777/FFFFFF?text=I" alt="Instagram">
        </a>
        <a href="https://www.linkedin.com/company/drsmithclinic" target="_blank" title="LinkedIn">
          <img src="https://placehold.co/28x28/777777/FFFFFF?text=Li" alt="LinkedIn">
        </a>
      </div>
    </div>

    <!-- Center column: Call to action -->
    <div class="footer-column footer-column-2">
            <h4 class="footer-question">Have any questions?</h4>
      <p class="footer-contact-email">
        <a href="mailto:info@drsmithclinic.com">info@drsmithclinic.com</a>
      </p>
      <div class="footer-buttons">
        <a href="mailto:info@drsmithclinic.com" class="btn btn-primary footer-btn">Email Us</a>
        <a href="tel:++1 123 456 7890" class="btn btn-outline footer-btn">Call Now</a>
      </div>
    </div>

    <!-- Right column: Quick links -->
    <div class="footer-column footer-column-3">
      <h5 class="footer-links-title">Quick Links</h5>
      <ul class="footer-links-list">
        <li><a href="/about-us/">About Us</a></li>
        <li><a href="/services/">Services</a></li>
        <li><a href="/patient-info/">Patient Info</a></li>
        <li><a href="/contact/">Contact</a></li>
      </ul>
    </div>

  </div>

  <div class="footer-copyright">
    © 2025 Dr. Smith Medical Clinic. All rights reserved.
  </div>
</footer>


    <div class="end-scenario-overlay" id="endScenarioOverlay">
        <div class="end-scenario-modal">
            <p>The consultation has ended. You can now return or close this window.</p>
            <button id="closeModalButton">Close</button>
        </div>
    </div>

    <script>
        // DOM Elements
        const chatMessagesEl = document.getElementById('chatMessages');
        const userInputEl = document.getElementById('userInput');
        const sendButtonEl = document.getElementById('sendButton');
        const endScenarioOverlayEl = document.getElementById('endScenarioOverlay');
        const closeModalButtonEl = document.getElementById('closeModalButton');
        const mobileMenuToggleEl = document.getElementById('mobileMenuToggle');
        const mainNavEl = document.getElementById('mainNav');
        
        // Hidden controls (for internal testing/setup)
        const personaToggleInternalEl = document.getElementById('personaToggleInternal');
        const sourcesToggleInternalEl = document.getElementById('sourcesToggleInternal');

        // Шаг 3: Добавьте ссылки на DOM-элементы панели цитат:
        const citationsPanelEl = document.getElementById('citationsPanel');
        const citationsListEl = document.getElementById('citationsList');
    
        // Persona Configuration
        const personaConfig = {
            bot: {
                name: "Zähnchen Bot",
                title: "AI Dental Assistant | Dr. Smith Medical Clinic",
                avatarType: "emoji", 
                avatarValue: "🤖" 
            },
            human: {
                name: "Virtual Assistant",
                title: "Virtual Assistant | Dr. Smith Medical Clinic",
                avatarType: "emoji",
                avatarValue: ""
            }
        };

        // Шаг 3: Добавьте объект allSourcesDetails и переменную citedSourcesInSession:
        const allSourcesDetails = {
    "Verified in Internal Appointment Management System": {
        titleFromOriginalList: "Verified in Internal Appointment Management System",
        url: "tierzahnzentrum.com",
        faviconUrl: "https://www.google.com/s2/favicons?sz=64&domain_url=tierzahnzentrum.com",
        description: "Appointment data verified against patient records."
    },
    "Clinic Contact Directory": {
        titleFromOriginalList: "Clinic Contact Directory",
        url: "tierzahnzentrum.com",
        faviconUrl: "https://www.google.com/s2/favicons?sz=64&domain_url=tierzahnzentrum.com",
        description: "Clinic staff and department contact list."
    },
    "Pet Owner Pre-Op Guidelines, revised March 2024": {
        titleFromOriginalList: "Pet Owner Pre-Op Guidelines (revised March 2024)",
        url: "tierzahnzentrum.com",
        faviconUrl: "https://www.google.com/s2/favicons?sz=64&domain_url=tierzahnzentrum.com",
        description: "Pre-surgery instructions for pet owners."
    },
    "Anaesthetic Hypothermia Prevention Guidelines, Veterinary Anaesthesia Association, 2024": {
        titleFromOriginalList: "Anaesthetic Hypothermia Prevention Guidelines, Veterinary Anaesthesia Association, 2024",
        url: "vaa.org",
        faviconUrl: "https://www.google.com/s2/favicons?sz=64&domain_url=vaa.org",
        description: "Normothermia maintenance during anesthesia."
    },
    "Kudo, A. et al. Peripheral warming for prevention of hypothermia in small dogs, 2024": {
        titleFromOriginalList: "Kudo, A. et al. Peripheral Warming for Prevention of Hypothermia in Small Dogs, 2024",
        url: "savj.org",
        faviconUrl: "https://www.google.com/s2/favicons?sz=64&domain_url=savj.org",
        description: "Study on warming pads reducing hypothermia in small dogs."
    },
    "Internal Clinic Protocol 09.10, last reviewed March 2024": {
        titleFromOriginalList: "Internal Clinic Protocol 09.10: Perioperative Temperature Management (last reviewed March 2024)",
        url: "tierzahnzentrum.com",
        faviconUrl: "https://www.google.com/s2/favicons?sz=64&domain_url=tierzahnzentrum.com",
        description: "Clinic procedures for patient temperature control."
    },
    "MSD Veterinary Manual, Chapter 15: Anaesthetic Management, 2023": {
        titleFromOriginalList: "Merck Veterinary Manual – Chapter 15: Anaesthetic Management (2023)",
        url: "merckvetmanual.com",
        faviconUrl: "https://www.google.com/s2/favicons?sz=64&domain_url=merckvetmanual.com",
        description: "Overview of anesthesia management in animals."
    },
    "Clinic Anaesthesia Monitoring Standards, Protocol №5.10, updated February 2024": {
        titleFromOriginalList: "Clinic Anaesthesia Monitoring Standards, Protocol № 5.10 (updated February 2024)",
        url: "tierzahnzentrum.com",
        faviconUrl: "https://www.google.com/s2/favicons?sz=64&domain_url=tierzahnzentrum.com",
        description: "Minimum monitoring requirements during anesthesia."
    },
    "AVMA Anaesthesia Safety Report, 2020": {
        titleFromOriginalList: "AVMA Anaesthesia Safety Report, 2020",
        url: "avma.org",
        faviconUrl: "https://www.google.com/s2/favicons?sz=64&domain_url=avma.org",
        description: "Report on anesthesia safety and adverse events."
    }
};


        let citedSourcesInSession = new Set();

    /* ---------- Profile Card helper (adds one card, then leaves it) ------------ */
    function showPersonaProfileCard(){
        const persona = personaConfig[currentAiPersonaKey];

        // Build card container
        const card = document.createElement('div');
        card.classList.add('persona-profile-card');

        card.innerHTML = `
            <p class="profile-heading">
                ${currentAiPersonaKey==='human'
                    ? ''
                    : 'You are chatting with our AI assistant:'}
            </p>
            <div class="profile-photo">
                ${persona.avatarType==='image'
                    ? `<img src="${persona.avatarValue}" alt="${persona.name}" onerror="this.onerror=null;this.src='https://placehold.co/96x96/eeeeee/999999?text=Avatar';">`
                    : `<span class="profile-emoji">${persona.avatarValue}</span>`}
            </div>
            <h3 class="profile-name">${persona.name}</h3>
            <p class="profile-title">${persona.title}</p>
        `;

        /* Mount either in the stub (if present) or at the end of messages */
        (document.getElementById('profileCardMount') || chatMessagesEl).appendChild(card);
    }
    /* -------------------------------------------------------------------------- */

        // --- ИЗМЕНЕНИЯ ЗДЕСЬ: Установка значений по умолчанию ---
        // Чтобы управлять поведением по умолчанию, меняйте значения именно этих двух переменных:
        let currentAiPersonaKey = 'human'; // Установите 'bot' или 'human'. Сейчас по умолчанию 'bot'.
                                         // Комментарий: 'Default AI persona. Options: 'human' (Lena Bauer) or 'bot' (VetBot)'
        let showSources = true;         // Установите true (показывать) или false (скрывать). Сейчас по умолчанию false (скрыты).
                                         // Комментарий: 'Default source visibility. Options: true (show) or false (hide)'
        // --- КОНЕЦ ИЗМЕНЕНИЙ ЗДЕСЯ ---
    
    
        const chatScenario = [
    {
        type: 'GREETING_CB',
        text: "Welcome to Dr. Smith Medical Clinic! I am the practice's virtual assistant and will be happy to help you. Before we start, please indicate your name and phone number in case the practice needs to contact you."
    },
    {
        type: 'PO_INPUT',
        expectedText: "Hi, my name is Alex and you can reach me on +1 234 567 8910."
    },
    {
        type: 'CB',
        text: "Thank you. What can I do for you?"
    },
    {
        type: 'PO_INPUT',
        expectedText: "I would like to have a medical assessment."
    },
    {
        type: 'CB',
        text: "All right. What symptoms do you have?"
    },
    {
        type: 'PO_INPUT',
        expectedText: "I have pain in my hip."
    },
    {
        type: 'CB',
        text: "Okay. Now let us talk in more detail about your symptoms. How long have you had hip pain?"
    },
    {
        type: 'PO_INPUT',
        expectedText: "The pain has been present for several days."
    },
    {
        type: 'CB',
        text: "All right. Where exactly does the hip pain occur?"
    },
    {
        type: 'PO_INPUT',
        expectedText: "The pain occurs mainly on the left side of my hip."
    },
    {
        type: 'CB',
        text: "Okay. Does the pain occur primarily while walking, afterward, or even at rest or during the night?"
    },
    {
        type: 'PO_INPUT',
        expectedText: "Mostly after movement. Especially after training, there is a pulling sensation on the outside of the hip. It does not hurt when I am lying down or at rest."
    },
    {
        type: 'CB',
        text: "I see. Have you recently exercised in an unusual way, e.g. through a new sport or a particularly intensive sports session?"
    },
    {
        type: 'PO_INPUT',
        expectedText: "I can not remember anything unusual that has happened. I have been starting to run a little more intensively some time ago."
    },
    {
        type: 'CB',
        text: "Have you noticed any local redness, swelling, numbness or experienced fever within the last days?"
    },
    {
        type: 'PO_INPUT',
        expectedText: "No. I have not noticed or experienced any of the above."
    },
    {
        type: 'CB',
        text: "Thank you very much for the information provided. I now have all relevant details for an initial assessment."
    },
    {
        type: 'LONG_CB',
text: `Based on clinically established patterns and a structured assessment of your responses, the symptoms are most consistent with a functional overload of the lateral hip joint – a common consequence of increased physical activity. There is no indication of severe hip joint inflammation or any other critical condition. In typical cases, symptoms of this kind improve gradually within approximately one week.

The practice will contact you tomorrow via the phone number provided at the beginning of the chat to follow up on the progress of your symptoms.

Given the discomfort you are experiencing, would you like me to provide some measures you can immediately take to ease it?`
},

    {
        type: 'PO_INPUT',
        expectedText: "Yes, please. What can I do to reduce the pain?"
    },
    {
        type: 'LONG_CB',
text: `Aside from general rest (reduced walking) and cooling of the left hip (2–3 times a day for 15 minutes), you can try the following to reduce the pain:

• Targeted stretching exercises for the hip muscles
• Non-prescription medications or natural remedies

Would you like me to provide more information on any of these points?`
},

    {
        type: 'PO_INPUT',
        expectedText: "Yes. Which stretching exercise would help me?"
    },
    {
        type: 'CB',
        text: "The most effective exercise for lateral hip pain is the \"Hipster\" stretch, which releases tightness on the outer hip."
    },
    {
        type: 'PO_INPUT',
        expectedText: "Okay. Can you explain this stretching exercise to me?"
    },
    {
        type: 'LONG_CB',
        text: "Sit with your legs straight, lean forward from the hips with a straight back, reach toward your feet, and hold the gentle stretch in your hips for 20–30 seconds. Return to the starting position and repeat 2–3 times, ideally twice a day."
    },
    {
        type: 'PO_INPUT',
        expectedText: "Okay, I got it. Just one more question: What alternative treatments would be helpful in my case?"
    },
    {
        type: 'LONG_CB',
        text: "The best alternative treatment in your case are quark compresses, which help relieve pain and soothe the affected area. They are also an effective preventive measure to avoid local swelling. Would you like more information on applying quark compresses?"
    },
    {
        type: 'PO_INPUT',
        expectedText: "No, I am already familiar with their application."
    },
    {
        type: 'CB',
        text: "Do you have any other questions? If not feel free to close the chat."
    },
    {
        type: 'PO_INPUT',
        expectedText: "No, I am finished now."
    },
    {
        type: 'END_SCENARIO'
    }
];
    
        let currentScenarioIndex = 0;
        let autoSendTimer = null;
        let firstUserInputActivated = false;
    
        function getCurrentTimestamp() {
            return new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
        }
    
        // Шаг 3: Замените существующую функцию processSources:
        function processSources(text) {
            // Regex updated to make "Source: " optional and capture the actual source name.
            // Also, the ##i## is part of the source marker, not the name itself.
            const sourceRegex = /\s*\((?:Source:\s*)?([^()]+?)##i##\)/g;
            let processedText = text;
            let match;

            // First, iterate through the text to find all sources and add them to citedSourcesInSession
            // We need a new RegExp object for each exec loop if using 'g' flag and want to restart search
            const findSourcesRegex = new RegExp(sourceRegex.source, sourceRegex.flags); 
            while ((match = findSourcesRegex.exec(text)) !== null) {
                // match[1] will now contain the source name without "Source: "
                const sourceKey = match[1].trim(); 
                if (allSourcesDetails[sourceKey]) {
                    citedSourcesInSession.add(sourceKey);
                }
            }

            // Then, process the text for display (remove or create buttons)
            if (!showSources) {
                // If sources are off, remove the entire (Source: Name##i##) block
                processedText = text.replace(sourceRegex, ''); 
            } else {
                // If sources are on, replace with buttons
                // When replacing for the button, match[1] (capturedSourceName) is already the correct key.
                processedText = text.replace(sourceRegex, (originalMatch, capturedSourceName) => {
                    const sourceKeyForButton = capturedSourceName.trim(); // This is the actual source name
                    const tooltipId = `tooltip-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
                    // Tooltip should display the actual source name
                    const cleanCitationTextForTooltip = sourceKeyForButton.replace(/"/g, '"'); 

                    const buttonHtml = `<button class="source-button" aria-describedby="${tooltipId}" title="${cleanCitationTextForTooltip}">i<span class="tooltip-text" role="tooltip" id="${tooltipId}">${cleanCitationTextForTooltip}<span class="tooltip-arrow"></span></span></button>`;
                    // Preserve leading space if present
                    return originalMatch.startsWith(" (") ? " " + buttonHtml : buttonHtml;
                });
            }
            return processedText;
        }

        // Шаг 3: Добавьте новую функцию updateCitationsPanel:
        function updateCitationsPanel() {
            if (!citationsPanelEl || !citationsListEl) return;

            citationsListEl.innerHTML = ''; // Clear previous citations

            if (!showSources) {
                citationsPanelEl.classList.remove('hidden');
                citationsListEl.innerHTML =
                    '<p class="empty-state">No sources cited yet in this session.</p>';
                return;
            }

            citationsPanelEl.classList.remove('hidden');

            if (citedSourcesInSession.size === 0) {
                citationsListEl.innerHTML = '<p class="empty-state">No sources cited yet in this session.</p>';
            } else {
                citedSourcesInSession.forEach(sourceKey => {
                    const sourceData = allSourcesDetails[sourceKey];
                    if (sourceData) {
                        const listItem = document.createElement('li');

                        let faviconHtml = '';
                        if (sourceData.faviconUrl) {
                            faviconHtml = `<img src="${sourceData.faviconUrl}" alt="" class="source-favicon" onerror="this.onerror=null;this.src='https://placehold.co/16x16/eeeeee/999999?text=F';this.alt='Favicon failed to load';">`;
                        }

                        const linkHref = sourceData.url && sourceData.url.startsWith("http") ? sourceData.url : `https://${sourceData.url}`;
                        
                        // Corrected template literal for listItem.innerHTML
                        listItem.innerHTML = `
                            ${faviconHtml}
                            <div class="source-details">
                                <div class="source-title">${sourceData.titleFromOriginalList}</div>
                                ${sourceData.url ? `<div class="source-url"><a href="${linkHref}" target="_blank" rel="noopener noreferrer">${sourceData.url}</a></div>` : ''}
                                <div class="source-description">${sourceData.description}</div>
                                <div class="source-meta">
                                    ${sourceData.type ? `<span>Type: ${sourceData.type}</span>` : ''}
                                    ${sourceData.likelyContent ? `<span>Likely Content: ${sourceData.likelyContent}</span>` : ''}
                                </div>
                            </div>`;
                        citationsListEl.appendChild(listItem);
                    }
                    citationsPanelEl.scrollTo({top: citationsPanelEl.scrollHeight, behavior: 'smooth'}); // <--- ДОБАВИТЬ ЭТУ СТРОКУ (Added this line)
                });
            }
        }
    
        function addMessageToChat(text, senderType) {
            const outerWrapper = document.createElement('div');
            outerWrapper.classList.add('message-wrapper');
    
            if (senderType === 'ai') {
                outerWrapper.classList.add('ai-message-wrapper');
                const persona = personaConfig[currentAiPersonaKey];
    
                const avatarDiv = document.createElement('div');
                avatarDiv.classList.add('avatar');
                if (persona.avatarType === 'image') {
                    const avatarImg = document.createElement('img');
                    avatarImg.src = persona.avatarValue;
                    avatarImg.alt = persona.name + " avatar";
                    avatarImg.onerror = function() { this.onerror=null; this.src='https://placehold.co/40x40/eeeeee/999999?text=Ava'; };
                    avatarDiv.appendChild(avatarImg);
                } else { 
                    avatarDiv.textContent = persona.avatarValue;
                }
                outerWrapper.appendChild(avatarDiv);
    
                const messageContentWrapper = document.createElement('div');
                messageContentWrapper.classList.add('message-content-wrapper');
    
                const nameDiv = document.createElement('div');
                nameDiv.classList.add('sender-name');
                nameDiv.textContent = persona.name;
                messageContentWrapper.appendChild(nameDiv);
    
                if (persona.title) {
                    const titleDiv = document.createElement('div');
                    titleDiv.classList.add('sender-title');
                    titleDiv.textContent = persona.title;
                    messageContentWrapper.appendChild(titleDiv);
                }
    
                const messageBubbleDiv = document.createElement('div');
                messageBubbleDiv.classList.add('message', 'ai-message');
                
                const textParagraph = document.createElement('p');
                // Process sources *before* adding to DOM to collect all source keys
                const processedTextForBubble = processSources(text); 
                textParagraph.innerHTML = processedTextForBubble;
                messageBubbleDiv.appendChild(textParagraph);
                
                messageContentWrapper.appendChild(messageBubbleDiv);
                outerWrapper.appendChild(messageContentWrapper);

                updateCitationsPanel(); // <--- ДОБАВИТЬ ЭТУ СТРОКУ (Added this line)
    
            } else { // user message
                outerWrapper.classList.add('user-message-wrapper');
                
                // Add avatar placeholder for consistent layout
                const avatarDiv = document.createElement('div');
                avatarDiv.classList.add('avatar');
                avatarDiv.style.visibility = 'hidden'; // Hide the avatar but keep space
                outerWrapper.appendChild(avatarDiv);
                
                const messageContentWrapper = document.createElement('div');
                messageContentWrapper.classList.add('message-content-wrapper');

                const nameDiv = document.createElement('div');
                nameDiv.classList.add('sender-name');
                nameDiv.textContent = 'Alex';
                messageContentWrapper.appendChild(nameDiv);

                const titleDiv = document.createElement('div');
                titleDiv.classList.add('sender-title');
                titleDiv.textContent = '(You)';
                messageContentWrapper.appendChild(titleDiv);
                
                const messageBubbleDiv = document.createElement('div');
                messageBubbleDiv.classList.add('message', 'user-message');
    
                const textParagraph = document.createElement('p');
                textParagraph.textContent = text;
                messageBubbleDiv.appendChild(textParagraph);
                messageContentWrapper.appendChild(messageBubbleDiv);
                outerWrapper.appendChild(messageContentWrapper);
            }
            
            const bubbleForTimestamp = outerWrapper.querySelector('.message');
            if (bubbleForTimestamp) {
                const timestampSpan = document.createElement('span');
                timestampSpan.classList.add('timestamp');
                timestampSpan.textContent = getCurrentTimestamp();
                bubbleForTimestamp.appendChild(timestampSpan);
            }
    
            chatMessagesEl.appendChild(outerWrapper);
            outerWrapper.classList.add('animate-in'); // ← запускаем CSS-анимацию
            chatMessagesEl.scrollTo({ top: chatMessagesEl.scrollHeight, behavior: 'smooth' });
        }
    
        function showTypingIndicator() {
            const persona = personaConfig[currentAiPersonaKey];
            const outerWrapper = document.createElement('div');
            outerWrapper.classList.add('message-wrapper', 'ai-message-wrapper', 'typing-indicator');
    
            const avatarDiv = document.createElement('div');
            avatarDiv.classList.add('avatar');
            if (persona.avatarType === 'image') {
                const avatarImg = document.createElement('img');
                avatarImg.src = persona.avatarValue;
                avatarImg.alt = persona.name + " avatar";
                avatarImg.onerror = function() { this.onerror=null; this.src='https://placehold.co/40x40/eeeeee/999999?text=Ava'; };
                avatarDiv.appendChild(avatarImg);
            } else { 
                avatarDiv.textContent = persona.avatarValue;
            }
            outerWrapper.appendChild(avatarDiv);
    
            const messageContentWrapper = document.createElement('div');
            messageContentWrapper.classList.add('message-content-wrapper');
    
            const nameDiv = document.createElement('div');
            nameDiv.classList.add('sender-name');
            nameDiv.textContent = persona.name;
            messageContentWrapper.appendChild(nameDiv);
    
            if (persona.title) {
                const titleDiv = document.createElement('div');
                titleDiv.classList.add('sender-title');
                titleDiv.textContent = persona.title;
                messageContentWrapper.appendChild(titleDiv);
            }
            
            const messageBubbleDiv = document.createElement('div');
            messageBubbleDiv.classList.add('message', 'ai-message'); 
            messageBubbleDiv.innerHTML = `<p>${persona.name} is preparing response...</p>`;
            messageContentWrapper.appendChild(messageBubbleDiv);
            
            outerWrapper.appendChild(messageContentWrapper);
    
            chatMessagesEl.appendChild(outerWrapper);
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
            return outerWrapper; 
        }
    
        function handleNextScenarioStep() {
            if (currentScenarioIndex >= chatScenario.length) return;
    
            const step = chatScenario[currentScenarioIndex];
            userInputEl.disabled = true;
            sendButtonEl.disabled = true;
            clearTimeout(autoSendTimer); 
    
            if (step.type === 'GREETING_CB' || step.type === 'CB' || step.type === 'LONG_CB') {
                const typingIndicator = showTypingIndicator(); 
                let delay;
                if (step.type === 'LONG_CB') {
                    delay = 20000;
                } else if (step.type === 'GREETING_CB') {
                    delay = 200;
                } else {
                    delay = 5000;
                }
                setTimeout(() => {
                    if (typingIndicator && typingIndicator.parentNode) {
                        chatMessagesEl.removeChild(typingIndicator);
                    }
                    addMessageToChat(step.text, 'ai'); 
                    currentScenarioIndex++;
                   if (currentScenarioIndex < chatScenario.length && chatScenario[currentScenarioIndex].type === 'PO_INPUT') {
    userInputEl.disabled = true;
    sendButtonEl.disabled = true;

    const userSimulatedInput = chatScenario[currentScenarioIndex].expectedText;
    
    const wordCount = step.text.split(/\s+/).length;
    const readingDelay = 1000 + (wordCount * 200); // Base 1s + 200ms per word
    
    setTimeout(() => {
        userInputEl.disabled = false; // Enable input
        userInputEl.focus(); // Focus to make it look active

        // Set the text immediately without typing animation
        userInputEl.value = userSimulatedInput;
        userInputEl.style.height = 'auto';
        userInputEl.style.height = (userInputEl.scrollHeight) + 'px';

        // Highlight send button for first user input only
        if (!firstUserInputActivated) {
            sendButtonEl.classList.add('highlight-send-button');
            firstUserInputActivated = true;
            setTimeout(() => {
                sendButtonEl.classList.remove('highlight-send-button');
            }, 3500);
        }

        sendButtonEl.disabled = false;

        // Optional: Auto-submit the input after a short delay (you can remove this if not needed)
        autoSendTimer = setTimeout(() => {
            if (!sendButtonEl.disabled) {
                handleSendMessage();
            }
        }, 60000); // <- hier Delay bis Auto-Absenden
    }, readingDelay); // Dynamic reading delay
} else if (currentScenarioIndex < chatScenario.length && chatScenario[currentScenarioIndex].type !== 'END_SCENARIO') {
                        handleNextScenarioStep(); 
                    } else if (currentScenarioIndex < chatScenario.length && chatScenario[currentScenarioIndex].type === 'END_SCENARIO') {
                        handleNextScenarioStep(); 
                    }
                }, delay);
            } else if (step.type === 'END_SCENARIO') {
                userInputEl.placeholder = "Consultation ended.";
                setTimeout(() => { 
                    endScenarioOverlayEl.style.display = 'flex';
                }, 1000);
            }
        }
    
        function handleSendMessage() {
            const messageText = userInputEl.value.trim();
            if (!messageText) return;
    
            if (currentScenarioIndex < chatScenario.length && chatScenario[currentScenarioIndex].type === 'PO_INPUT') {
                clearTimeout(autoSendTimer); 
                addMessageToChat(messageText, 'user'); 
                userInputEl.value = '';
                userInputEl.style.height = 'auto';
                sendButtonEl.disabled = true;
                userInputEl.disabled = true;
                sendButtonEl.classList.remove('highlight-send-button');
                
                currentScenarioIndex++; 
                handleNextScenarioStep();
            }
        }
    
        userInputEl.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            const canEnableSend = this.value.trim() && currentScenarioIndex < chatScenario.length && chatScenario[currentScenarioIndex].type === 'PO_INPUT';
            sendButtonEl.disabled = !canEnableSend;
    
            if (canEnableSend && !firstUserInputActivated && sendButtonEl) {
                 sendButtonEl.classList.add('highlight-send-button');
                 firstUserInputActivated = true; 
                 setTimeout(() => {
                     sendButtonEl.classList.remove('highlight-send-button');
                 }, 3500);
            }
        });
    
        sendButtonEl.addEventListener('click', handleSendMessage);
        userInputEl.addEventListener('keypress', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                if (!sendButtonEl.disabled) {
                    handleSendMessage();
                }
            }
        });
    
        closeModalButtonEl.addEventListener('click', () => {
            endScenarioOverlayEl.style.display = 'none';
        });
        
    if (mobileMenuToggleEl && mainNavEl) {
        mobileMenuToggleEl.addEventListener('click', () => {
            const isActive = mainNavEl.classList.toggle('mobile-active');
            mobileMenuToggleEl.classList.toggle('active', isActive);
            mobileMenuToggleEl.innerHTML = isActive ? '✕' : '☰'; 
            document.body.style.overflow = isActive ? 'hidden' : ''; 

            if (isActive) {
                mainNavEl.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', () => {
                        mainNavEl.classList.remove('mobile-active');
                        mobileMenuToggleEl.classList.remove('active');
                        mobileMenuToggleEl.innerHTML = '☰';
                        document.body.style.overflow = '';
                    }, { once: true }); 
                });
            }
        });
    }
    
        // --- ИЗМЕНЕНИЯ ЗДЕСЬ: Логика скрытых контролов ---
        personaToggleInternalEl.addEventListener('change', (event) => {
            currentAiPersonaKey = event.target.value;
            // Potentially re-render profile card or update existing messages if persona changes mid-chat
            // For this exercise, we assume it's set at the start.
        });

        // Шаг 3: Обновите обработчик события для sourcesToggleInternalEl:
        sourcesToggleInternalEl.addEventListener('change', (event) => {
            showSources = event.target.checked;
            updateCitationsPanel(); // Update the side panel's visibility and content

            // Update visibility of existing source buttons in messages
            // This requires re-processing existing messages or simply toggling button visibility
            // For simplicity, let's toggle visibility of existing buttons.
            // A more robust solution might re-render messages if sources are toggled.
            const allSourceButtons = document.querySelectorAll('.chat-messages .source-button');
            allSourceButtons.forEach(button => {
                button.style.display = showSources ? 'inline-block' : 'none';
            });
            // If sources are turned OFF, existing ##i## markers might become visible if not handled by processSources.
            // The current processSources will remove them if showSources is false.
            // To ensure all messages are updated, one might need to iterate and re-process their content.
            // For now, this focuses on the panel and new messages.
        });
        
        function initializeDefaultSettings() {
            if (personaToggleInternalEl) {
                personaToggleInternalEl.value = currentAiPersonaKey;
            }
            if (sourcesToggleInternalEl) {
                sourcesToggleInternalEl.checked = showSources;
            }
        }
        // --- КОНЕЦ ИЗМЕНЕНИЙ ЗДЕСЯ ---
    
        // Initialize chat
        // Шаг 3: Обновите инициализацию чата при загрузке DOM:
        document.addEventListener('DOMContentLoaded', () => {
            initializeDefaultSettings();      
            showPersonaProfileCard();         
            updateCitationsPanel(); // <--- ДОБАВИТЬ ЭТУ СТРОКУ (Added this line)
            handleNextScenarioStep();         
        });
    </script>
	
</body>
</html>