<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #101820; 
            color: #F0F2F5; 
            overscroll-behavior-y: contain; 
        }
        .header-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }
        .action-button {
            background-color: #34D399; 
            color: #064E3B; 
            font-weight: 600;
        }
        .quick-reply-chip { 
            background-color: #374151; 
            color: #E5E7EB; 
            border: 1px solid #4B5563; 
        }
        .quick-reply-chip:hover, .quick-reply-chip.selected {
            background-color: #4B5563;
            border-color: #34D399; 
        }
        .message-input-container {
            background-color: #1F2937; 
            border-color: #374151;
        }
        .message-input {
            background-color: transparent;
        }
        .planner-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .assistant-message-bubble {
            background-color: #1F2937; 
            border-radius: 16px 16px 16px 4px; 
        }
        .assistant-message-bubble table { /* Style for table inside bubble */
            margin-top: 8px;
            border-collapse: collapse;
        }
        .assistant-message-bubble th,
        .assistant-message-bubble td {
            padding: 4px 8px;
            text-align: left;
            border-bottom: 1px solid #374151; /* Lighter border for table */
        }
        .assistant-message-bubble td:first-child {
            padding-left: 0;
        }
        .assistant-message-bubble td:last-child a {
            white-space: nowrap;
        }


        .user-message-bubble {
            background-color: #34D399; 
            color: #064E3B; 
            border-radius: 16px 16px 4px 16px;
        }
        .main-image-container {
            background-color: #1F2937; 
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; 
            position: relative; 
        }
        .main-image-container img, .main-image-container video {
            width: 100%;
            height: 100%;
            object-fit: contain; 
            border-radius: 0.5rem; 
        }
        .tag-dot {
            position: absolute;
            width: 24px;
            height: 24px;
            background-color: rgba(52, 211, 153, 0.8); 
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            border: 1px solid white;
            box-shadow: 0 0 8px rgba(0,0,0,0.5);
            z-index: 10; /* Ensure tags are above image */
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #34D399; 
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -20px;
            margin-left: -20px;
            z-index: 100;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .thumbnail-strip {
            display: flex;
            overflow-x: auto;
            padding-bottom: 8px; 
            gap: 8px;
        }
        .thumbnail-strip::-webkit-scrollbar {
            height: 6px;
        }
        .thumbnail-strip::-webkit-scrollbar-thumb {
            background: #4B5563;
            border-radius: 3px;
        }
        .thumbnail-item {
            flex-shrink: 0;
            width: 100px;
            height: 75px;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            position: relative; 
        }
        .thumbnail-item:hover, .thumbnail-item.selected {
            border-color: #34D399;
        }
        .thumbnail-item img {
            width: 100%;
            height: 100%;
            object-fit: cover; 
        }
        .thumbnail-item .caption {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0,0,0,0.6);
            color: white;
            font-size: 10px;
            padding: 2px 4px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #chatLogContainer {
             scroll-behavior: smooth;
        }
        .source-option-card, .preference-card {
            background-color: #1F2937;
            border: 1px solid #374151;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .source-option-card:hover, .preference-card:hover {
            transform: translateY(-2px); 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-color: #4B5563;
        }
         .preference-card.selected {
            border-color: #34D399; 
            transform: translateY(-2px);
            box-shadow: 0 0 0 2px #34D399; 
        }
        .source-option-icon {
            width: 32px; 
            height: 32px;
            color: #34D399; 
        }
        .ai-preview-image-container { 
            width: 100%;
            height: 150px; 
            background-color: #101820; 
            border-radius: 0.375rem; 
            overflow: hidden; 
        }
        .ai-preview-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover; 
        }
        .preference-section-title {
            font-size: 1.125rem; 
            font-weight: 600; 
            margin-bottom: 0.75rem; 
            color: #E5E7EB; 
        }
        .style-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem; 
        }
        .style-card { 
            background-color: #27303F; 
            color: #D1D5DB;
        }
        .style-card img {
            width: 100%;
            height: 80px; 
            object-fit: cover; 
            border-bottom: 1px solid #374151; 
        }
        .function-option {
            background-color: #1F2937;
            border: 1px solid #374151;
            color: #D1D5DB;
        }
        .function-option:hover {
             border-color: #4B5563;
        }
        .function-option.selected {
            border-color: #34D399;
            background-color: #27303F;
        }
        .function-option input[type="radio"] {
            appearance: none;
            -webkit-appearance: none;
            width: 1.25em;
            height: 1.25em;
            border: 2px solid #4B5563;
            border-radius: 50%;
            outline: none;
            cursor: pointer;
            margin-right: 0.75rem; 
            transition: background-color 0.2s, border-color 0.2s;
        }
        .function-option input[type="radio"]:checked {
            background-color: #34D399;
            border-color: #34D399;
        }
        .function-option input[type="radio"]:checked::after { 
            content: '';
            display: block;
            width: 0.65em;
            height: 0.65em;
            margin: auto;
            background-color: #101820; 
            border-radius: 50%;
            position: relative;
            top: 50%;
            transform: translateY(-50%);
        }
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); 
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000; 
        }
        .modal-content {
            background-color: #1F2937; 
            padding: 20px;
            border-radius: 12px; 
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px; 
            position: relative;
            color: #E5E7EB; 
        }
        .modal-close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.8rem; 
            color: #9CA3AF; 
            cursor: pointer;
            line-height: 1;
        }
        .modal-close-button:hover {
            color: #E5E7EB; 
        }
        .modal-title {
            font-size: 1.25rem; 
            font-weight: 600; 
            margin-bottom: 1rem; 
            text-align: center;
        }
        .modal-rug-option {
            display: flex;
            align-items: center;
            padding: 12px; 
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
            border: 1px solid #374151; 
        }
        .modal-rug-option:hover {
            background-color: #374151; 
        }
        .modal-rug-option:last-child {
            margin-bottom: 0;
        }
        .modal-rug-option img {
            width: 60px; 
            height: 45px;
            object-fit: cover;
            border-radius: 6px;
            margin-right: 15px; 
        }
        .modal-rug-option-details {
            flex-grow: 1;
        }
        .modal-rug-option-name {
            font-weight: 500; 
        }
        .modal-rug-option-price {
            font-size: 0.875rem; 
            color: #9CA3AF; 
        }
        /* Custom styles for range slider */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent; /* Otherwise the native one will show */
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            background: #374151; /* Darker track */
            height: 0.5rem; /* 8px */
            border-radius: 0.25rem; /* 4px */
        }
        input[type="range"]::-moz-range-track {
            background: #374151;
            height: 0.5rem;
            border-radius: 0.25rem;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; /* Override default look */
            appearance: none;
            margin-top: -4px; /* Centers thumb on track */
            background-color: #34D399; /* Green thumb */
            height: 1.25rem; /* 20px */
            width: 1.25rem; /* 20px */
            border-radius: 50%;
            border: 2px solid #101820; /* Border to match body bg for definition */
        }
        input[type="range"]::-moz-range-thumb {
            background-color: #34D399;
            height: 1.25rem;
            width: 1.25rem;
            border-radius: 50%;
            border: 2px solid #101820;
        }
        input[type="range"]:focus::-webkit-slider-thumb { /* Optional: focus style for thumb */
             box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.5);
        }
        input[type="range"]:focus::-moz-range-thumb {
             box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.5);
        }


    </style>
</head>
<body class="flex flex-col h-screen">

    <div id="scanPage" class="flex flex-col h-full">
        <header class="sticky top-0 z-50 p-4 flex items-center space-x-4 bg-[#101820]">
            <svg id="backFromScanPage" class="header-icon cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            <h1 class="text-xl font-semibold">Scan</h1>
        </header>
        <main class="flex-grow flex flex-col items-center justify-between p-6 space-y-6 overflow-y-auto">
            <div class="w-full max-w-md">
                <div class="w-full h-64 rounded-lg main-image-container mb-8 shadow-lg">
                    <video id="scanVideo" class="rounded-lg" autoplay muted loop playsinline>
                        <source src="https://files.catbox.moe/fqanl2.mp4" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
                <h2 class="text-2xl font-bold text-center mb-2">Scan complete</h2>
                <p class="text-center text-gray-400 mb-8">
                    Your scan is complete. You can now start planning your space.
                </p>
            </div>
            <div class="w-full max-w-md mt-auto pb-4 sticky bottom-0 bg-[#101820] pt-2">
                 <button id="startPlanningBtn" class="w-full action-button py-3 px-4 rounded-lg text-lg shadow-md">
                    Start planning
                </button>
            </div>
        </main>
    </div>

    <div id="designPreferencesPage" class="hidden flex-col h-full">
        <header class="sticky top-0 z-50 p-4 flex items-center space-x-4 bg-[#101820]">
            <svg id="backToScanFromPreferencesBtn" class="header-icon cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            <h1 class="text-xl font-semibold">Set Design Preferences</h1>
        </header>
        <main class="flex-grow p-6 space-y-6 overflow-y-auto">
            <div class="w-full max-w-2xl mx-auto"> 
                <section>
                    <h2 class="preference-section-title">Choose a Style</h2>
                    <div id="styleOptionsContainer" class="style-card-grid">
                        </div>
                </section>
                <section class="mt-6">
                    <h2 class="preference-section-title">Select a Mood</h2>
                    <div id="moodOptionsContainer" class="flex flex-wrap gap-2">
                        </div>
                </section>
                <section class="mt-6">
                    <h2 class="preference-section-title">What's the Room For?</h2>
                    <div id="functionOptionsContainer" class="space-y-3">
                        </div>
                </section>
                <section class="mt-6">
                    <h2 class="preference-section-title">Budget Preference</h2>
                    <div class="mt-2 px-1"> <input type="range" id="budgetSlider" min="1" max="3" value="2" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-xs text-gray-400 mt-1">
                            <span>Budget-friendly</span>
                            <span>Mid-range</span>
                            <span>Premium</span>
                        </div>
                    </div>
                </section>

                <section class="mt-6">
                    <h2 class="preference-section-title">Any Other Feedback?</h2>
                    <textarea id="otherFeedbackInput" rows="3" class="w-full p-2.5 rounded-lg bg-gray-800 border border-gray-600 placeholder-gray-500 text-white focus:ring-green-500 focus:border-green-500" placeholder="E.g., 'I love plants', 'Need a pet-friendly sofa', 'Lots of natural light...'"></textarea>
                </section>
            </div>
        </main>
        <footer class="sticky bottom-0 z-50 p-4 bg-[#101820] border-t border-gray-700">
            <button id="continueToSourceSelectionBtn" class="w-full action-button py-3 px-4 rounded-lg text-lg shadow-md">
                Continue
            </button>
        </footer>
    </div>

    <div id="sourceSelectionPage" class="hidden flex-col h-full">
        <header class="sticky top-0 z-50 p-4 flex items-center space-x-4 bg-[#101820]">
            <svg id="backToPreferencesFromSourceSelectionBtn" class="header-icon cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            <h1 class="text-xl font-semibold">Choose Design Source</h1>
        </header>
        <main class="flex-grow flex flex-col items-center justify-center p-6 space-y-6 overflow-y-auto">
            <div class="w-full max-w-md space-y-4">
                <div id="uploadPhotoOption" class="source-option-card p-6 rounded-lg cursor-pointer flex items-center space-x-4">
                    <svg class="source-option-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                    </svg>
                    <div>
                        <h3 class="text-lg font-semibold">Upload Your Photo</h3>
                        <p class="text-sm text-gray-400">Select an image from your device.</p>
                    </div>
                </div>
                <div id="takePhotoOption" class="source-option-card p-6 rounded-lg cursor-pointer flex items-center space-x-4">
                    <svg class="source-option-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" />
                    </svg>
                    <div>
                        <h3 class="text-lg font-semibold">Take a Photo</h3>
                        <p class="text-sm text-gray-400">Use your device's camera.</p>
                    </div>
                </div>
                <div id="aiRecommendationOption" class="source-option-card p-6 rounded-lg cursor-pointer space-y-3">
                    <div class="flex items-center space-x-4 mb-3">
                        <svg class="source-option-icon" clip-rule="evenodd" fill-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" id="fi_14461626" fill="currentColor"><g transform="translate(-1688 -8)"><path d="m1728 14h-6v-6h-4v6h-6v-6h-4v6h-4c-2.65 0-5.2 1.054-7.07 2.929-1.88 1.875-2.93 4.419-2.93 7.071v4h-6v4h6v6h-6v4h6v6h-6v4h6v4c0 2.652 1.05 5.196 2.93 7.071 1.87 1.875 4.42 2.929 7.07 2.929h4v6h4v-6h6v6h4v-6h6v6h4v-6h4c2.65 0 5.2-1.054 7.07-2.929 1.88-1.875 2.93-4.419 2.93-7.071v-4h6v-4h-6v-6h6v-4h-6v-6h6v-4h-6v-4c0-2.652-1.05-5.196-2.93-7.071-1.87-1.875-4.42-2.929-7.07-2.929h-4v-6h-4zm14 10v32c0 1.591-.63 3.117-1.76 4.243-1.12 1.125-2.65 1.757-4.24 1.757h-32c-1.59 0-3.12-.632-4.24-1.757-1.13-1.126-1.76-2.652-1.76-4.243v-32c0-1.591.63-3.117 1.76-4.243 1.12-1.125 2.65-1.757 4.24-1.757h32c1.59 0 3.12.632 4.24 1.757 1.13 1.126 1.76 2.652 1.76 4.243zm-14 4v24h4v-24zm-20 7v17h4v-7h6v7h4v-17c0-3.866-3.13-7-7-7s-7 3.134-7 7zm10 6v-6c0-1.657-1.34-3-3-3s-3 1.343-3 3v6z"></path></g></svg>
                        <div>
                            <h3 class="text-lg font-semibold">AI Generated Room Scan</h3>
                            <p class="text-sm text-gray-400">Start with an AI-prepared empty room based on your scan.</p>
                        </div>
                    </div>
                    <div class="ai-preview-image-container">
                        <img src="https://files.catbox.moe/6myqsa.jpg" alt="AI Generated Empty Room Preview" >
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="planPage" class="hidden flex-col h-full">
        <header class="sticky top-0 z-50 p-4 flex items-center space-x-4 bg-[#101820]">
            <svg id="backToSourceSelectionFromPlanBtn" class="header-icon cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            <h1 class="text-xl font-semibold">Plan Your Space</h1>
        </header>
        <main class="flex-grow flex flex-col space-y-1 overflow-y-auto relative">
            <div id="planPageImageContainer" class="w-full h-56 md:h-72 main-image-container my-1 shadow-lg relative flex-shrink-0">
                 <img id="planPageImage" src="https://files.catbox.moe/6myqsa.jpg" alt="Current Design" class="rounded-lg"> 
                 <div id="spinner" class="spinner hidden"></div>
            </div>
            <div id="chatLogContainer" class="flex-grow flex flex-col space-y-3 p-4 overflow-y-auto">
            </div>
        </main>
        <footer class="sticky bottom-0 z-50 p-3 space-y-2 bg-[#101820] border-t border-gray-700 flex-shrink-0">
            <div id="quickReplyOrThumbnailContainer" class="w-full">
            </div>
            <div class="flex items-center message-input-container p-2 rounded-lg border">
                <input type="text" id="messageInput" placeholder="Message Planner..." class="flex-grow message-input text-white focus:outline-none px-2">
                <button id="sendMessageBtn" class="ml-2">
                    <svg class="header-icon text-gray-400 hover:text-gray-200" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd"></path></svg>
                </button>
            </div>
        </footer>
    </div>

    <div id="rugSelectionModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="closeRugModalBtn" class="modal-close-button">&times;</button>
            <h3 class="modal-title">Choose a Rug Style</h3>
            <div id="modalRugOptionsContainer">
                </div>
        </div>
    </div>


    <script>
        // DOM Elements
        const scanPage = document.getElementById('scanPage');
        const designPreferencesPage = document.getElementById('designPreferencesPage');
        const sourceSelectionPage = document.getElementById('sourceSelectionPage');
        const planPage = document.getElementById('planPage');
        const rugSelectionModal = document.getElementById('rugSelectionModal'); 
        const modalRugOptionsContainer = document.getElementById('modalRugOptionsContainer');
        const closeRugModalBtn = document.getElementById('closeRugModalBtn');


        const startPlanningBtn = document.getElementById('startPlanningBtn');
        const backFromScanPage = document.getElementById('backFromScanPage');
        const backToScanFromPreferencesBtn = document.getElementById('backToScanFromPreferencesBtn');
        const continueToSourceSelectionBtn = document.getElementById('continueToSourceSelectionBtn');
        const backToPreferencesFromSourceSelectionBtn = document.getElementById('backToPreferencesFromSourceSelectionBtn');
        const backToSourceSelectionFromPlanBtn = document.getElementById('backToSourceSelectionFromPlanBtn'); 

        const styleOptionsContainer = document.getElementById('styleOptionsContainer');
        const moodOptionsContainer = document.getElementById('moodOptionsContainer');
        const functionOptionsContainer = document.getElementById('functionOptionsContainer');
        const budgetSlider = document.getElementById('budgetSlider'); // New
        const otherFeedbackInput = document.getElementById('otherFeedbackInput'); // New

        const uploadPhotoOption = document.getElementById('uploadPhotoOption');
        const takePhotoOption = document.getElementById('takePhotoOption');
        const aiRecommendationOption = document.getElementById('aiRecommendationOption');
        
        const scanVideo = document.getElementById('scanVideo');
        const planPageImageContainer = document.getElementById('planPageImageContainer');
        const planPageImage = document.getElementById('planPageImage');
        const spinner = document.getElementById('spinner');
        const chatLogContainer = document.getElementById('chatLogContainer');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const quickReplyOrThumbnailContainer = document.getElementById('quickReplyOrThumbnailContainer');

        // --- Image URLs ---
        const initialPlanImage = 'https://files.catbox.moe/6myqsa.jpg'; 
        const design1Image = 'https://files.catbox.moe/qzly8o.jpg';    
        const design2ImageCloudGrey = 'https://files.catbox.moe/3b0w8d.jpg'; 
        const designWarmSand = 'https://files.catbox.moe/lmbrhg.jpg'; 
        const designSageStripe = 'https://files.catbox.moe/sajdmt.jpg'; 

        const rugOptionCloudGreyThumb = 'https://files.catbox.moe/3b0w8d.jpg'; 
        const rugOptionWarmSandThumb = 'https://files.catbox.moe/lmbrhg.jpg'; 
        const rugOptionSageStripeThumb = 'https://files.catbox.moe/sajdmt.jpg';

        let currentChatStep = 0;
        let tagDotsVisible = false;
        let selectedPreferences = { style: null, mood: null, roomFunction: null, budget: '2', otherFeedback: '' };


        // --- Design Preferences Data & Population ---
        const designStyles = [
            { id: 'modern', name: 'Modern', icon: 'üõãÔ∏è', image: 'https://images.pexels.com/photos/259962/pexels-photo-259962.jpeg?auto=compress&h=450', alt: 'Airy modern living room with light wood floors and neutral sofa' },
            { id: 'scandinavian', name: 'Scandinavian', icon: 'üå≤', image: 'https://images.pexels.com/photos/1125136/pexels-photo-1125136.jpeg?auto=compress&h=450', alt: 'Calm Scandinavian scheme with pale walls, striped throw and ladder shelf' },
            { id: 'industrial', name: 'Industrial', icon: 'üè≠', image: 'https://images.pexels.com/photos/29252604/pexels-photo-29252604.jpeg?auto=compress&h=450', alt: 'Industrial loft with exposed brick, metal stair and hammock chair' },
            { id: 'bohemian', name: 'Bohemian', icon: 'üé®', image: 'https://images.pexels.com/photos/2959583/pexels-photo-2959583.jpeg?auto=compress&h=450', alt: 'Cozy boho nook full of plants, patterned cushions and warm wood' },
            { id: 'minimalist', name: 'Minimalist', icon: '‚ú®', image: 'https://images.pexels.com/photos/32189595/pexels-photo-32189595.jpeg?auto=compress&h=450', alt: 'Soft-curve minimalist sofa set in tone-on-tone neutrals' },
        ];
        const designMoods = [
            { id: 'cozy', name: 'Cozy', icon: 'üî•' }, { id: 'calm', name: 'Calm', icon: 'üßò' },
            { id: 'vibrant', name: 'Vibrant', icon: 'üåü' }, { id: 'elegant', name: 'Elegant', icon: 'üíé' },
        ];
        const roomFunctions = [
            { id: 'livingroom', name: 'Living Room', icon: 'üõãÔ∏è' }, { id: 'bedroom', name: 'Bedroom', icon: 'üõèÔ∏è' },
            { id: 'homeoffice', name: 'Home Office', icon: 'üíª' }, { id: 'diningroom', name: 'Dining Room', icon: 'üçΩÔ∏è' },
        ];

        function populatePreferenceOptions() {
            styleOptionsContainer.innerHTML = designStyles.map(style => `
                <button data-type="style" data-value="${style.id}" class="preference-card style-card p-3 rounded-lg text-left focus:outline-none flex flex-col h-full items-center">
                    <img src="${style.image}" alt="${style.alt}" loading="lazy" class="w-full h-20 object-cover rounded-md mb-2" onerror="this.onerror=null;this.src='https://placehold.co/120x80/1F2937/E5E7EB?text=${style.name.substring(0,3)}';this.alt='${style.name}'">
                    <span class="block font-medium break-words mt-auto text-sm text-center">${style.name} ${style.icon}</span>
                </button>
            `).join('');
            moodOptionsContainer.innerHTML = designMoods.map(mood => `
                <button data-type="mood" data-value="${mood.id}" class="preference-card quick-reply-chip px-4 py-2 rounded-full text-sm font-medium focus:outline-none">
                    ${mood.icon} ${mood.name}
                </button>
            `).join('');
            functionOptionsContainer.innerHTML = roomFunctions.map(func => `
                <label class="function-option flex items-center p-3 rounded-lg hover:bg-gray-700 cursor-pointer preference-card">
                    <input type="radio" name="roomFunction" data-type="roomFunction" value="${func.id}" class="mr-3">
                    <span class="">${func.icon} ${func.name}</span>
                </label>
            `).join('');

            document.querySelectorAll('#designPreferencesPage .preference-card').forEach(card => {
                card.addEventListener('click', handlePreferenceSelection);
            });
            document.querySelectorAll('#designPreferencesPage input[name="roomFunction"]').forEach(radio => {
                radio.addEventListener('click', handlePreferenceSelection); 
            });
            // Event listeners for new elements
            budgetSlider.addEventListener('input', handlePreferenceSelection);
            otherFeedbackInput.addEventListener('input', handlePreferenceSelection); // Use 'input' for live updates, or 'blur'
        }
        
        function handlePreferenceSelection(event) {
            let target = event.currentTarget;
            let type, value;

            if (target.id === 'budgetSlider') {
                type = 'budget';
                value = target.value; // 1, 2, or 3
            } else if (target.id === 'otherFeedbackInput') {
                type = 'otherFeedback';
                value = target.value;
            } else if (target.matches('input[type="radio"]')) { 
                type = target.dataset.type;
                value = target.value;
                document.querySelectorAll('#functionOptionsContainer .function-option').forEach(label => {
                    label.classList.remove('selected');
                });
                target.closest('.function-option').classList.add('selected');
            } else { 
                type = target.dataset.type;
                value = target.dataset.value;
                document.querySelectorAll(`#designPreferencesPage .preference-card[data-type='${type}']`).forEach(btn => {
                    btn.classList.remove('selected');
                });
                target.classList.add('selected');
            }
            selectedPreferences[type] = value;
            console.log("Selected Preferences:", selectedPreferences);
        }


        // --- Navigation ---
        function showPage(pageToShow) {
            [scanPage, designPreferencesPage, sourceSelectionPage, planPage, rugSelectionModal].forEach(page => {
                if (page === pageToShow) {
                    page.classList.remove('hidden');
                    page.classList.add('flex'); 
                    if (page === rugSelectionModal) page.classList.add('items-center', 'justify-center'); 
                } else {
                    page.classList.add('hidden');
                    page.classList.remove('flex', 'items-center', 'justify-center');
                }
            });
        }

        startPlanningBtn.addEventListener('click', () => {
            showPage(designPreferencesPage);
            if (scanVideo) scanVideo.pause(); 
        });
        
        backFromScanPage.addEventListener('click', () => {
            console.log("Back button on initial scan page clicked.");
        });

        backToScanFromPreferencesBtn.addEventListener('click', () => {
            showPage(scanPage);
            if(scanVideo) scanVideo.play();
        });

        continueToSourceSelectionBtn.addEventListener('click', () => {
            showPage(sourceSelectionPage);
        });
        
        backToPreferencesFromSourceSelectionBtn.addEventListener('click', () => {
            showPage(designPreferencesPage);
        });
        
        backToSourceSelectionFromPlanBtn.addEventListener('click', () => {
            showPage(sourceSelectionPage);
            resetChat(); 
        });

        uploadPhotoOption.addEventListener('click', () => {
            addMessageToChat('system', "Upload Photo selected. (File picker would open here)");
            proceedToPlanPage();
        });

        takePhotoOption.addEventListener('click', () => {
            addMessageToChat('system', "Take Photo selected. (Camera would activate here)");
            proceedToPlanPage();
        });

        aiRecommendationOption.addEventListener('click', () => {
            addMessageToChat('system', "AI Generated Room Scan selected.");
            proceedToPlanPage();
        });

        function proceedToPlanPage() {
            showPage(planPage);
            planPageImage.src = initialPlanImage; 
            startChatFlow(selectedPreferences); 
        }

        // --- Chat Logic ---
        const NEXT_STEP_QUICK_REPLIES = ["Looks good!", "Show other rug options", "Change another item", "Start over"];

        /* ---------- SHORTLIST DATA ---------- */
        const SHORTLIST = [
          { emoji:'üõãÔ∏è', name:'S√ñDERHAMN 3-seat sofa, beige', price:'$799',
            link:'https://www.ikea.com/us/en/p/soederhamn-sofa-viarp-beige-brown-s59305706/' },
          { emoji:'üçÉ', name:'Maymar triangular coffee table, white', price:'$99',
            link:'https://www.amazon.com/dp/B0DWWV4B4V' },
          { emoji:'üìö', name:'LACK floating shelf 43‚Ä≥ √ó 10‚Ä≥ (√ó2)', price:'$15 each',
            link:'https://www.ikea.com/us/en/p/lack-wall-shelf-white-90282180/' },
          { emoji:'üå≤', name:'Slatted wood wall-panel set (15 pcs)', price:'$199',
            link:'https://www.homedepot.com/p/Ekena-Millwork-Slatwall-Panels/326010027' },
          { emoji:'üß∫', name:'LOHALS jute rug 6‚Ä≤6‚Ä≥ √ó 9‚Ä≤10‚Ä≥', price:'$149',
            link:'https://www.ikea.com/us/en/p/lohals-rug-flatwoven-natural-00277395/' },
          { emoji:'ü™Ñ', name:'Cotton throw, sage', price:'$19',
            link:'https://www2.hm.com/en_us/productpage.123456.html' }, // Example link
        ];
        function renderShortlist () {
          return `
            <table class="text-sm w-full">
              <tbody>
                ${SHORTLIST.map(
                  i=>`<tr>
                        <td class="pr-2 py-1">${i.emoji}</td>
                        <td class="pr-2 py-1">${i.name}</td>
                        <td class="pr-2 py-1 font-semibold">${i.price}</td>
                        <td class="py-1"><a href="${i.link}" target="_blank"
                               class="text-green-400 underline">Link</a></td>
                      </tr>`
                ).join('')}
              </tbody>
            </table>`;
        }


        function resetChat() {
            currentChatStep = 0;
            chatLogContainer.innerHTML = '';
            quickReplyOrThumbnailContainer.innerHTML = '';
            messageInput.value = '';
            hideTagDots();
        }

        function startChatFlow(preferences = {}) { 
            resetChat(); 
            currentChatStep = 1;
            let initialAssistantMessage = "Hey there!";
            
            if (preferences.style || preferences.mood || preferences.roomFunction || preferences.budget || preferences.otherFeedback) {
                initialAssistantMessage += " Based on your preferences";
                if (preferences.style) initialAssistantMessage += ` (Style: ${preferences.style.charAt(0).toUpperCase() + preferences.style.slice(1)})`;
                if (preferences.mood) initialAssistantMessage += ` (Mood: ${preferences.mood.charAt(0).toUpperCase() + preferences.mood.slice(1)})`;
                if (preferences.roomFunction) initialAssistantMessage += ` (Room: ${preferences.roomFunction.replace('room', ' Room').replace('homeoffice', 'Home Office')})`;
                
                let budgetText = "";
                if (preferences.budget === '1') budgetText = "Budget-friendly";
                else if (preferences.budget === '2') budgetText = "Mid-range";
                else if (preferences.budget === '3') budgetText = "Premium";
                if (budgetText) initialAssistantMessage += ` (Budget: ${budgetText})`;

                if (preferences.otherFeedback) initialAssistantMessage += ` and your note: "${preferences.otherFeedback.substring(0, 30)}${preferences.otherFeedback.length > 30 ? '...' : ''}"`;
                
                initialAssistantMessage += ", I've swept 1 000+ stores. I‚Äôve got six in-stock pieces totalling about $1 190. Want to see the shortlist? üëÄ";
            } else {
                 initialAssistantMessage = "Hey there! I ran your style picks and swept 1 000+ stores. I‚Äôve got six in-stock pieces totalling about $1 190. Want to see the shortlist? üëÄ";
            }
            
            addMessageToChat('assistant', initialAssistantMessage);
            showQuickReplies(["Yes, show me", "No, let me pick"]);
        }
        
        function addMessageToChat(sender, text, isHTML = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('flex', 'max-w-full', 'px-1');
            const bubble = document.createElement('div');
            bubble.classList.add('p-3', 'rounded-lg', 'max-w-[85%]', 'break-words'); 

            if (sender === 'system') { 
                messageDiv.classList.add('justify-center', 'my-2');
                bubble.classList.add('bg-gray-700', 'text-gray-300', 'text-xs', 'italic', 'px-3', 'py-1');
                bubble.textContent = text;
                messageDiv.appendChild(bubble);
            } else if (sender === 'assistant') {
                messageDiv.classList.add('justify-start');
                const avatar = document.createElement('img');
                avatar.src = 'https://placehold.co/40x40/718096/E2E8F0?text=A'; 
                avatar.alt = 'Assistant';
                avatar.classList.add('planner-avatar', 'mr-2', 'mt-1', 'self-start');
                messageDiv.appendChild(avatar);
                
                const messageContentWrapper = document.createElement('div');
                const senderName = document.createElement('span');
                senderName.classList.add('text-xs', 'text-gray-400', 'mb-0.5', 'block');
                senderName.textContent = 'Planner';
                messageContentWrapper.appendChild(senderName);

                bubble.classList.add('assistant-message-bubble');
                if (isHTML) {
                    bubble.innerHTML = text;
                } else {
                    bubble.textContent = text;
                }
                messageContentWrapper.appendChild(bubble);
                messageDiv.appendChild(messageContentWrapper);
            } else { // user
                messageDiv.classList.add('justify-end');
                bubble.classList.add('user-message-bubble');
                bubble.textContent = text;
                messageDiv.appendChild(bubble);
            }
            chatLogContainer.appendChild(messageDiv);
            if (chatLogContainer.scrollHeight > 0) { 
               chatLogContainer.scrollTop = chatLogContainer.scrollHeight;
            }
        }

        function showQuickReplies(replies) {
            quickReplyOrThumbnailContainer.innerHTML = ''; 
            quickReplyOrThumbnailContainer.classList.remove('thumbnail-strip');
            const buttonContainer = document.createElement('div');
            buttonContainer.classList.add('flex', 'flex-wrap', 'gap-2', 'justify-center', 'py-1');

            replies.forEach(replyText => {
                const button = document.createElement('button');
                button.classList.add('quick-reply-chip', 'py-2', 'px-4', 'rounded-full', 'text-sm');
                button.textContent = replyText;
                button.onclick = () => handleQuickReply(replyText);
                buttonContainer.appendChild(button);
            });
            quickReplyOrThumbnailContainer.appendChild(buttonContainer);
        }


        function handleQuickReply(replyText) {
            addMessageToChat('user', replyText);
            quickReplyOrThumbnailContainer.innerHTML = ''; 

            if (currentChatStep === 1 && replyText === "Yes, show me") {
              addMessageToChat('assistant', renderShortlist(), true);   
              currentChatStep = 1.2;                                    
              showQuickReplies(["Looks great ‚Äî furnish it", "Swap an item"]);
              return;                                                   
            }

            if (currentChatStep === 1.2 && replyText === "Looks great ‚Äî furnish it") {
                currentChatStep = 2; 
                showSpinnerWithMessage("Styling your space...");
                setTimeout(() => {
                    hideSpinner();
                    updateMainImage(design1Image); 
                    addMessageToChat('assistant', "Here‚Äôs your starter look. <b>Hint:</b> tap any <span class='text-green-400 font-bold'>Ôºã</span> to tweak items ‚Äî e.g. ‚ÄòSwap the rug‚Äô.", true);
                    showTagDotsOnImage(); 
                }, 2000); 
            } else if (currentChatStep === 1.2 && replyText === "Swap an item") {
                 addMessageToChat('assistant', "Okay, which item from the shortlist would you like to swap? Or tell me what you're looking for.");
                 currentChatStep = 1.5; 
            }
            else if (currentChatStep === 1 && replyText === "No, let me pick") {
                addMessageToChat('assistant', "Okay, what kind of items are you interested in first? (e.g., 'sofa styles', 'rug colors')");
                currentChatStep = 1.5; 
            }
            else if (currentChatStep === 4 && NEXT_STEP_QUICK_REPLIES.includes(replyText)) {
                quickReplyOrThumbnailContainer.innerHTML = ''; 
                if (replyText === "Looks good!") {
                    addMessageToChat('assistant', "Great! Happy to help further if you need anything else.");
                } else if (replyText === "Change another item") {
                    addMessageToChat('assistant', "Sure, what would you like to change? You can tap a '+' on an item or tell me.");
                    if (!tagDotsVisible && (planPageImage.src.includes(design1Image) || planPageImage.src.includes(design2ImageCloudGrey) || planPageImage.src.includes(designWarmSand) || planPageImage.src.includes(designSageStripe) )) { 
                         showTagDotsOnImage(); 
                    }
                } else if (replyText === "Start over") {
                    showPage(designPreferencesPage); 
                    resetChat();
                    selectedPreferences = { style: null, mood: null, roomFunction: null, budget: '2', otherFeedback: '' }; 
                    budgetSlider.value = '2'; // Reset slider UI
                    otherFeedbackInput.value = ''; // Reset textarea UI
                    populatePreferenceOptions(); 
                } else if (replyText === "Show other rug options") {
                    currentChatStep = 3; 
                    addMessageToChat('assistant', "Okay, here are some other rug options:");
                    showRugThumbnails(); 
                }
            }
        }

        sendMessageBtn.addEventListener('click', handleSendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSendMessage();
            }
        });

        function handleSendMessage() {
            const messageText = messageInput.value.trim();
            if (!messageText) return;

            addMessageToChat('user', messageText);
            messageInput.value = '';
            const lowerMessageText = messageText.toLowerCase();

            if (currentChatStep >= 2 && (lowerMessageText.includes("swap the rug") || lowerMessageText.includes("change the rug"))) {
                addMessageToChat('assistant', "Okay, I've swapped the rug to a stylish blue-grey option for you!");
                showSpinnerWithMessage("Updating the rug...");
                setTimeout(() => {
                    hideSpinner();
                    updateMainImage(design2ImageCloudGrey); 
                    currentChatStep = 4; 
                    showQuickReplies(NEXT_STEP_QUICK_REPLIES);
                }, 1500);
            } else if (currentChatStep >= 2 && lowerMessageText.includes("lighter rug")) { 
                currentChatStep = 3;
                addMessageToChat('assistant', "Sure. Here are some lighter rug options:");
                showRugThumbnails();
            } else if (currentChatStep === 1.5) { 
                 addMessageToChat('assistant', `Okay, looking for options for: "${messageText}"...`);
            } else {
                addMessageToChat('assistant', "I'm processing that. One moment...");
            }
        }

        function showSpinnerWithMessage(message) {
            spinner.classList.remove('hidden');
            console.log(message); 
        }
        function hideSpinner() {
            spinner.classList.add('hidden');
        }

        function updateMainImage(imageUrl) {
            planPageImage.src = imageUrl;
            if (imageUrl === initialPlanImage) { 
                hideTagDots();
            }
        }

        function showTagDotsOnImage() { 
            const existingTags = planPageImageContainer.querySelectorAll('.tag-dot');
            existingTags.forEach(tag => tag.remove());
            const tags = [
                { top: '65%', left: '50%' }, { top: '80%', left: '35%' }, 
                { top: '35%', left: '30%' }, { top: '70%', left: '80%' }  
            ];
            tags.forEach((tagPos, index) => {
                const dot = document.createElement('div');
                dot.classList.add('tag-dot');
                dot.style.top = tagPos.top;
                dot.style.left = tagPos.left;
                dot.textContent = '+';
                dot.onclick = () => handleTagClick(index, tagPos);
                planPageImageContainer.appendChild(dot);
            });
            tagDotsVisible = true;
        }

        function hideTagDots() {
            const existingTags = planPageImageContainer.querySelectorAll('.tag-dot');
            existingTags.forEach(tag => tag.remove());
            tagDotsVisible = false;
        }

        // --- Rug Modal Logic ---
        const RUG_OPTIONS_FOR_MODAL = [
            { name: "Cloud-Grey", price: "‚Ç¨110", image: rugOptionCloudGreyThumb, mainImage: design2ImageCloudGrey }, 
            { name: "Warm Sand", price: "‚Ç¨120", image: rugOptionWarmSandThumb, mainImage: designWarmSand }, 
            { name: "Sage Stripe", price: "‚Ç¨115", image: rugOptionSageStripeThumb, mainImage: designSageStripe } 
        ];

        function showRugSelectionModal() {
            modalRugOptionsContainer.innerHTML = ''; 
            RUG_OPTIONS_FOR_MODAL.forEach(option => {
                const optionDiv = document.createElement('div');
                optionDiv.classList.add('modal-rug-option');
                optionDiv.innerHTML = `
                    <img src="${option.image}" alt="${option.name}">
                    <div class="modal-rug-option-details">
                        <div class="modal-rug-option-name">${option.name}</div>
                        <div class="modal-rug-option-price">${option.price}</div>
                    </div>
                `;
                optionDiv.onclick = () => handleRugSelectionFromModal(option);
                modalRugOptionsContainer.appendChild(optionDiv);
            });
            rugSelectionModal.classList.remove('hidden');
            rugSelectionModal.classList.add('flex'); 
        }

        function hideRugSelectionModal() {
            rugSelectionModal.classList.add('hidden');
            rugSelectionModal.classList.remove('flex');
        }

        closeRugModalBtn.addEventListener('click', hideRugSelectionModal);
        rugSelectionModal.addEventListener('click', (event) => { 
            if (event.target === rugSelectionModal) {
                hideRugSelectionModal();
            }
        });


        function handleRugSelectionFromModal(rugOption) {
            hideRugSelectionModal();
            addMessageToChat('user', `Selected: ${rugOption.name} (${rugOption.price}) from modal.`);
            quickReplyOrThumbnailContainer.innerHTML = ''; 
            quickReplyOrThumbnailContainer.classList.remove('thumbnail-strip');
            showSpinnerWithMessage(`Updating to ${rugOption.name} rug...`);
            setTimeout(() => {
                hideSpinner();
                updateMainImage(rugOption.mainImage);
                addMessageToChat('assistant', "Rug updated! Anything else?");
                currentChatStep = 4; 
                showQuickReplies(NEXT_STEP_QUICK_REPLIES);
                if (rugOption.mainImage !== initialPlanImage) {
                    showTagDotsOnImage();
                }
            }, 1500);
        }
        
        function handleTagClick(index, position) {
            if (currentChatStep === 2 && index === 1) { 
                addMessageToChat('user', `Tapped on the coffee table area.`);
                addMessageToChat('assistant', `Looking for rug options for you...`);
                showRugSelectionModal();
            } else {
                addMessageToChat('user', `Tapped on item #${index + 1}.`);
                let itemName = "selected item";
                if (index === 0) itemName = "sofa";
                else if (index === 1) itemName = "coffee table / rug area"; 
                else if (index === 2) itemName = "shelf";
                else if (index === 3) itemName = "side table";
                addMessageToChat('assistant', `You tapped the ${itemName}. What would you like to do? (e.g., 'Change color', 'Find similar', 'Remove')`);
            }
        }


        function showRugThumbnails() { 
            quickReplyOrThumbnailContainer.innerHTML = ''; 
            quickReplyOrThumbnailContainer.classList.add('thumbnail-strip');
            
            RUG_OPTIONS_FOR_MODAL.forEach(option => { 
                const thumbDiv = document.createElement('div');
                thumbDiv.classList.add('thumbnail-item');
                thumbDiv.onclick = () => handleRugSelection(option); 
                const img = document.createElement('img');
                img.src = option.image;
                img.alt = option.name;
                thumbDiv.appendChild(img);
                const caption = document.createElement('div');
                caption.classList.add('caption');
                caption.textContent = `${option.name} (${option.price})`;
                thumbDiv.appendChild(caption);
                quickReplyOrThumbnailContainer.appendChild(thumbDiv);
            });
        }

        function handleRugSelection(rugOption) {
            addMessageToChat('user', `Selected: ${rugOption.name} (${rugOption.price})`);
            quickReplyOrThumbnailContainer.innerHTML = ''; 
            quickReplyOrThumbnailContainer.classList.remove('thumbnail-strip');
            showSpinnerWithMessage(`Updating to ${rugOption.name} rug...`);
            setTimeout(() => {
                hideSpinner();
                updateMainImage(rugOption.mainImage);
                addMessageToChat('assistant', "Rug updated! Anything else?");
                currentChatStep = 4; 
                showQuickReplies(NEXT_STEP_QUICK_REPLIES);
                if (rugOption.mainImage !== initialPlanImage) {
                    showTagDotsOnImage();
                }
            }, 1500);
        }

        // Initial population of preference options when script loads
        populatePreferenceOptions();

    </script>
</body>
</html>